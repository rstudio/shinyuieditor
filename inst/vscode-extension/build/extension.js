"use strict";var dt=Object.create;var $=Object.defineProperty;var ft=Object.getOwnPropertyDescriptor;var mt=Object.getOwnPropertyNames;var gt=Object.getPrototypeOf,_t=Object.prototype.hasOwnProperty;var ht=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),vt=(t,e)=>{for(var o in e)$(t,o,{get:e[o],enumerable:!0})},re=(t,e,o,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of mt(e))!_t.call(t,r)&&r!==o&&$(t,r,{get:()=>e[r],enumerable:!(n=ft(e,r))||n.enumerable});return t};var S=(t,e,o)=>(o=t!=null?dt(gt(t)):{},re(e||!t||!t.__esModule?$(o,"default",{value:t,enumerable:!0}):o,t)),Et=t=>re($({},"__esModule",{value:!0}),t);var Ve=ht((_o,He)=>{var z=require("util"),bt=require("path"),P=require("child_process").spawn,R=function(){},J="HKLM",Ce="HKCU",Ie="HKCR",be="HKU",Oe="HKCC",ke=[J,Ce,Ie,be,Oe],De="REG_SZ",Me="REG_MULTI_SZ",Le="REG_EXPAND_SZ",Ue="REG_DWORD",Ge="REG_QWORD",Fe="REG_BINARY",$e="REG_NONE",We=[De,Me,Le,Ue,Ge,Fe,$e],Ot="",kt=/(\\[a-zA-Z0-9_\s]+)*/,Dt=/^(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER|HKEY_CLASSES_ROOT|HKEY_USERS|HKEY_CURRENT_CONFIG)(.*)$/,Be=/^(.*)\s(REG_SZ|REG_MULTI_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_NONE)\s+([^\s].*)$/;function k(t,e){if(!(this instanceof k))return new k(t,e);Error.captureStackTrace(this,k),this.__defineGetter__("name",function(){return k.name}),this.__defineGetter__("message",function(){return t}),this.__defineGetter__("code",function(){return e})}z.inherits(k,Error);function N(t){var e={stdout:"",stderr:""};return t.stdout.on("data",function(o){e.stdout+=o.toString()}),t.stderr.on("data",function(o){e.stderr+=o.toString()}),e}function C(t,e,o){var n=o.stdout.trim(),r=o.stderr.trim(),s=z.format(`%s command exited with code %d:
%s
%s`,t,e,n,r);return new k(s,e)}function Mt(t){if(t=="x64")return"64";if(t=="x86")return"32";throw new Error("illegal architecture: "+t+" (use x86 or x64)")}function I(t,e){e&&t.push("/reg:"+Mt(e))}function b(){return process.platform==="win32"?bt.join(process.env.windir,"system32","reg.exe"):"REG"}function U(t,e,o,n,r,s,i){if(!(this instanceof U))return new U(t,e,o,n,r,s,i);var a=t,c=e,p=o,f=n,l=r,_=s,u=i;this.__defineGetter__("host",function(){return a}),this.__defineGetter__("hive",function(){return c}),this.__defineGetter__("key",function(){return p}),this.__defineGetter__("name",function(){return f}),this.__defineGetter__("type",function(){return l}),this.__defineGetter__("value",function(){return _}),this.__defineGetter__("arch",function(){return u})}z.inherits(U,Object);function m(t){if(!(this instanceof m))return new m(t);var e=t||{},o=""+(e.host||""),n=""+(e.hive||J),r=""+(e.key||""),s=e.arch||null;if(this.__defineGetter__("host",function(){return o}),this.__defineGetter__("hive",function(){return n}),this.__defineGetter__("key",function(){return r}),this.__defineGetter__("path",function(){return(o.length==0?"":"\\\\"+o+"\\")+n+r}),this.__defineGetter__("arch",function(){return s}),this.__defineGetter__("parent",function(){var i=r.lastIndexOf("\\");return new m({host:this.host,hive:this.hive,key:i==-1?"":r.substring(0,i),arch:this.arch})}),ke.indexOf(n)==-1)throw new Error("illegal hive specified.");if(!kt.test(r))throw new Error("illegal key specified.");if(s&&s!="x64"&&s!="x86")throw new Error("illegal architecture specified (use x86 or x64)")}m.HKLM=J;m.HKCU=Ce;m.HKCR=Ie;m.HKU=be;m.HKCC=Oe;m.HIVES=ke;m.REG_SZ=De;m.REG_MULTI_SZ=Me;m.REG_EXPAND_SZ=Le;m.REG_DWORD=Ue;m.REG_QWORD=Ge;m.REG_BINARY=Fe;m.REG_NONE=$e;m.REG_TYPES=We;m.DEFAULT_VALUE=Ot;m.prototype.values=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r="",s=this,i=null,a=N(n);return n.on("close",function(c){if(!i)if(c!==0)R("process exited with code "+c),e(C("QUERY",c,a),null);else{for(var p=[],f=[],l=r.split(`
`),_=0,u=0,g=l.length;u<g;u++){var d=l[u].trim();d.length>0&&(R(d),_!=0&&p.push(d),++_)}for(var u=0,g=p.length;u<g;u++){var v=Be.exec(p[u]),w,h,E;v&&(w=v[1].trim(),h=v[2].trim(),E=v[3],f.push(new U(s.host,s.hive,s.key,w,h,E,s.arch)))}e(null,f)}}),n.stdout.on("data",function(c){r+=c.toString()}),n.on("error",function(c){i=c,e(c)}),this};m.prototype.keys=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r="",s=this,i=null,a=N(n);return n.on("close",function(c){i||c!==0&&(R("process exited with code "+c),e(C("QUERY",c,a),null))}),n.stdout.on("data",function(c){r+=c.toString()}),n.stdout.on("end",function(){for(var c=[],p=[],f=r.split(`
`),l=0,_=f.length;l<_;l++){var u=f[l].trim();u.length>0&&(R(u),c.push(u))}for(var l=0,_=c.length;l<_;l++){var g=Dt.exec(c[l]),d,v;g&&(d=g[1],v=g[2],v&&v!==s.key&&p.push(new m({host:s.host,hive:s.hive,key:v,arch:s.arch})))}e(null,p)}),n.on("error",function(c){i=c,e(c)}),this};m.prototype.get=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var n=["QUERY",this.path];e==""?n.push("/ve"):n=n.concat(["/v",e]),I(n,this.arch);var r=P(b(),n,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),s="",i=this,a=null,c=N(r);return r.on("close",function(p){if(!a)if(p!==0)R("process exited with code "+p),o(C("QUERY",p,c),null);else{for(var f=[],l=null,_=s.split(`
`),u=0,g=0,d=_.length;g<d;g++){var v=_[g].trim();v.length>0&&(R(v),u!=0&&f.push(v),++u)}var w=f[f.length-1]||"",h=Be.exec(w),E,F,ne;h&&(E=h[1].trim(),F=h[2].trim(),ne=h[3],l=new U(i.host,i.hive,i.key,E,F,ne,i.arch)),o(null,l)}}),r.stdout.on("data",function(p){s+=p.toString()}),r.on("error",function(p){a=p,o(p)}),this};m.prototype.set=function(e,o,n,r){if(typeof r!="function")throw new TypeError("must specify a callback");if(We.indexOf(o)==-1)throw Error("illegal type specified.");var s=["ADD",this.path];e==""?s.push("/ve"):s=s.concat(["/v",e]),s=s.concat(["/t",o,"/d",n,"/f"]),I(s,this.arch);var i=P(b(),s,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),a=null,c=N(i);return i.on("close",function(p){a||(p!==0?(R("process exited with code "+p),r(C("ADD",p,c,null))):r(null))}),i.stdout.on("data",function(p){R(""+p)}),i.on("error",function(p){a=p,r(p)}),this};m.prototype.remove=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var n=e?["DELETE",this.path,"/f","/v",e]:["DELETE",this.path,"/f","/ve"];I(n,this.arch);var r=P(b(),n,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),s=null,i=N(r);return r.on("close",function(a){s||(a!==0?(R("process exited with code "+a),o(C("DELETE",a,i),null)):o(null))}),r.stdout.on("data",function(a){R(""+a)}),r.on("error",function(a){s=a,o(a)}),this};m.prototype.clear=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f","/va"];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r=null,s=N(n);return n.on("close",function(i){r||(i!==0?(R("process exited with code "+i),e(C("DELETE",i,s),null)):e(null))}),n.stdout.on("data",function(i){R(""+i)}),n.on("error",function(i){r=i,e(i)}),this};m.prototype.erase=m.prototype.clear;m.prototype.destroy=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f"];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r=null,s=N(n);return n.on("close",function(i){r||(i!==0?(R("process exited with code "+i),e(C("DELETE",i,s),null)):e(null))}),n.stdout.on("data",function(i){R(""+i)}),n.on("error",function(i){r=i,e(i)}),this};m.prototype.create=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["ADD",this.path,"/f"];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r=null,s=N(n);return n.on("close",function(i){r||(i!==0?(R("process exited with code "+i),e(C("ADD",i,s),null)):e(null))}),n.stdout.on("data",function(i){R(""+i)}),n.on("error",function(i){r=i,e(i)}),this};m.prototype.keyExists=function(e){return this.values(function(o,n){if(o)return o.code==1?e(null,!1):e(o);e(null,!0)}),this};m.prototype.valueExists=function(e,o){return this.get(e,function(n,r){if(n)return n.code==1?o(null,!1):o(n);o(null,!0)}),this};He.exports=m});var $t={};vt($t,{activate:()=>Ft});module.exports=Et($t);var oe=S(require("vscode"));var A=require("vscode"),x=S(require("vscode"));var j="app.R",yt=/^([\w|\s]+)([\.[\w|^\.]*]*)$/i;function Q(t){if(t==="")return{valid:!0,name:j};let e=t.match(yt);if(e===null)return{valid:!1,msg:`Invalid app name: ${t}.`};let[o,n,r]=e;return(r===""||r===".")&&(r=".R"),n?r!==".R"?{valid:!1,msg:`Invalid file extension: ${r}. Extension needs to be .R`}:(n=n.replaceAll(" ","-"),{valid:!0,name:`${n}${r}`}):{valid:!1,msg:`Invalid app name: ${t}. Make sure to only use numbers and letters. Spaces will be converted to dashes.`}}var se=new TextEncoder().encode("");async function ie(){let t=await A.window.showOpenDialog({canSelectFolders:!0,canSelectFiles:!0,title:"Choose location for Shiny app",openLabel:"Choose app folder or file",canSelectMany:!1,filters:{"R scripts":["R","r"]}});if(!t)return;let e=t[0],n=(await x.workspace.fs.stat(e)).type===x.FileType.Directory?await Rt(e):e;n&&x.commands.executeCommand("vscode.openWith",n,"shinyuieditor.appFile")}async function Rt(t){let e=(await A.workspace.fs.readDirectory(t)).filter(([i,a])=>a===x.FileType.File).map(([i,a])=>i),o=await A.window.showInputBox({prompt:"Enter file name for new app",placeHolder:j,validateInput(i){let a=Q(i);return a.valid?e.includes(a.name)?{message:`Run the editor on existing app: ${a.name}.`,severity:x.InputBoxValidationSeverity.Info}:{message:`Run the template chooser to build new app: ${a.name}.`,severity:x.InputBoxValidationSeverity.Info}:{message:a.msg,severity:x.InputBoxValidationSeverity.Error}}});if(!o)return;let n=Q(o);if(!n.valid){x.window.showErrorMessage(`Error processing requested file name: ${o}. Try with a different name.`);return}let r=A.Uri.joinPath(t,n.name);return e.includes(n.name)||await A.workspace.fs.writeFile(r,se),r}var ae=S(require("path")),pe=S(require("vscode")),W=require("vscode");function wt(t){let e=t.ext;return/\.R/i.test(e)}function ue(t="world"){let e=W.window.activeTextEditor;if(!e){W.window.showErrorMessage("No active file open to run ui editor on!");return}let o=ae.default.parse(e.document.fileName);if(!wt(o)){W.window.showErrorMessage(`Can't run the ui editor on the currently active file ${o.base}, needs to be a .R file.`);return}pe.commands.executeCommand("vscode.openWith",e.document.uri,"shinyuieditor.appFile")}var T=S(require("vscode"));function ce(t){return typeof t=="object"&&t!==null}function le(t){return ce(t)?"path"in t:!1}var de=St;function St(t,e,o){var n=null,r=null,s=function(){n&&(clearTimeout(n),r=null,n=null)},i=function(){var c=r;s(),c&&c()},a=function(){if(!e)return t.apply(this,arguments);var c=this,p=arguments,f=o&&!n;if(s(),r=function(){t.apply(c,p)},n=setTimeout(function(){if(n=null,!f){var l=r;return r=null,l()}},e),f)return r()};return a.cancel=s,a.flush=i,a}function fe(t){return typeof t=="object"&&t!==null}function B(t){return fe(t)&&"val"in t&&Array.isArray(t.val)}var M=class extends Error{constructor({message:o,cause:n}){super();this.name="AST_PARSING_ERROR",this.message=o,this.cause=n}};function xt(t,e){if(!B(t))return!1;let{val:o}=t;return o[0].val==="<-"||o[0].val==="="?e?o[1].val===e:!0:!1}function Tt(t){return t.val[1]}function Z(t){let e=[];return t.forEach(o=>{if(xt(o)){let n=Tt(o);At(n)?e.push({name:n.val[2].val,is_output:!0,node:o}):n.type==="s"&&e.push({name:n.val,is_output:!1,node:o})}if(B(o)){let n=Z(o.val);e.push(...n)}}),e}function At(t){if(!B(t))return!1;let{val:e}=t;return e.length===3&&e[1].val==="output"&&typeof e[2].val=="string"}function me(t){return t.filter(({is_output:e})=>e).reduce((e,{name:o,node:n})=>{let{pos:r}=n;return r&&(e[o]=[...e[o]??[],r]),e},{})}function ge(t){let e=t.find(({name:n,is_output:r})=>n==="server"&&!r);if(!e)throw new M({message:"No server assignment node was found in provided ast"});let{node:o}=e;if(!o.pos)throw new M({message:"No position info attached to the ui assignment node",cause:o});return o}function _e(t){let e=Z(t),o=ge(e).pos,n=me(e);return{app_type:"SINGLE-FILE",server_pos:o,get_output_position:s=>s in n?n[s]:null}}var nt=S(require("vscode"));var O=S(require("vscode"));async function he(t){let e=t.uri,o=new O.WorkspaceEdit,n=t.validateRange(new O.Range(0,0,1/0,1/0));o.replace(e,n,""),await O.workspace.applyEdit(o),t.save()}var L=S(require("vscode"));async function ve({appFile:t,existingEditor:e}){return e&&L.window.visibleTextEditors.includes(e)?e:await L.window.showTextDocument(t.uri,{viewColumn:L.ViewColumn.Beside,preview:!0})}async function Ee(t,e){let o=await t.runCmd(`print(require(${e}, quietly = TRUE))`,{verbose:!1});return o.status==="error"?{status:"error",msg:o.errorMsg}:o.values[0].includes("FALSE")?{status:"error",msg:Pt(e)}:{status:"success"}}function Pt(t){return`The ShinyUiEditor extension needs the \`${t}\` pkg installed. Install using \`remotes::install_github('rstudio/${t}')\` and restart the extension.`}function H(...t){return t.filter(o=>o!==void 0).reduce((o,n,r)=>(r===0?"":o+`
`)+n,"")}function ye(t){return t.replace(/(?<=\\)"/g,'\\\\"').replace(/\\n/g,"\\\\n").replace(/(?<!\\)"/g,'\\"')}function Re(t){return t.replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}async function X(t,e){let o=ye(e),n=H(`app_lines <- strsplit("${o}", "\\n")[[1]]`,"parsed <- parse(text = app_lines, keep.source = TRUE)","jsonlite::toJSON(","  shinyuieditor:::serialize_ast(parsed),","  auto_unbox = TRUE",")"),r=await t.runCmd(n,{verbose:!1,timeout_ms:5e3});if(r.status==="error")return r;try{let s=JSON.parse(r.values.reduce((i,a)=>i+`
`+a,""));return Object.keys(s).length===0?{status:"success",values:"EMPTY"}:{status:"success",values:s}}catch{return{status:"error",errorMsg:"Could not get document as json. Content is not valid json"}}}var xe=S(require("fs")),V=S(require("vscode"));var we=require("child_process");async function Se({cmd:t,args:e,verbose:o=!1,timeout_ms:n=1500}){let r=Nt(o,"runShellCommand: ");return new Promise(s=>{let i={stdout:[],stderr:[]},a=(0,we.spawn)(t,e);function c(){r("Spawned")}function p(d){r("Error "+d.message),u(),s({status:"error",errorMsgs:d.message,...i})}function f(){r("Close"),u(),s({status:"success",...i})}function l(d){r(`stdout: ${d.toString()}`),i.stdout.push(d.toString())}function _(d){r(`stderr: ${d.toString()}`),i.stderr.push(d.toString())}function u(){clearTimeout(g),a.off("spawn",c),a.off("error",p),a.off("close",f),a.stdout.off("data",l),a.stderr.off("data",_)}let g=setTimeout(()=>{s({status:"error",errorMsgs:`Command, no response from run command within ${n}ms:
${t} ${e?.join(" ")}`,...i}),u()},n);a.on("spawn",c),a.on("error",p),a.on("close",f),a.stdout.on("data",l),a.stderr.on("data",_)})}function Nt(t,e){return o=>{t&&console.log(e+o)}}async function Te(t){if(Ct())return await It(t);let e=V.Uri.parse(`http://localhost:${t}`);return(await V.env.asExternalUri(e)).toString()}var Ae="/usr/lib/rstudio-server/bin/rserver-url";function Ct(){return"RS_SERVER_URL"in process.env?xe.existsSync(Ae):!1}async function It(t){let e=await Se({cmd:Ae,args:[String(t)]});e.status==="error"&&Error(`Failed to get Posit workbench forwarded port. Error msg:
`+e.errorMsgs);let o=process.env.RS_SERVER_URL,n=process.env.RS_SESSION_URL;if(!o||!n)throw new Error("Can't find URL for workbench.");let r=e.stdout[0];return`${o}${n.slice(1)}p/${r}/`}var Pe=S(require("net"));async function Ne(){return new Promise(t=>{let e=Pe.default.createServer();e.listen(0,()=>{let o=e.address?.();if(typeof o=="string"||o===null)throw new Error("Failed to find a free port...");e.close(n=>t(o.port))})})}var Ze=require("child_process");var je=require("fs");var Ke=require("fs"),ee=S(require("path")),Ye=Ve();async function qe(){let t=process.platform,e=Lt(t);if(!e&&t==="win32")try{let o=new Ye({hive:Ye.HKLM,key:"\\Software\\R-Core\\R"}),n=await new Promise((r,s)=>o.get("InstallPath",(i,a)=>i===null?r(a):s(i)));e=ee.default.join(n.value,"bin","R.exe")}catch{e=""}return e}function Lt(t){let e=":",o="";t==="win32"&&(e=";",o=".exe");let n=process.env.PATH?process.env.PATH.split(e):[];for(let r of n){let s=ee.default.join(r,"R"+o);if((0,Ke.existsSync)(s))return s}return""}async function Qe(){let t=await qe();if(!t){let e="Cannot find R for running shinyuieditor. Make sure R is installed and/or updating the shinyuieditor extension settings option to proper to R path.";throw new Error(e)}if(!(0,je.existsSync)(t)){let e=`Path to R is invalid: ${t}. Make sure R is installed and/or updating the shinyuieditor extension settings option to proper to R path.`;throw new Error(e)}return Re(t)}async function Y(t,e={}){let o=await Qe();if(o===void 0)throw new Error("Can't get R path");let n="";return new Promise(r=>{let s=new AbortController,{signal:i}=s,a=(0,Ze.spawn)(o,t,{signal:i});a.on("spawn",f),a.on("error",l),a.on("close",_),a.stdout.on("data",u),a.stderr.on("data",g);function c(h,E){n+=`${h}: ${E}`}function p(h){e.verbose&&console.log(`%c[RProc ${a.pid}] %c${h.replaceAll(/\n$/g,"").replaceAll(/\n/g,`
\u2219\u2219\u2219 `)}`,"color: orangered;","color: grey; opacity: 0.5")}function f(){p("spawned"),clearTimeout(w),r({proc:a,stop:v,getIsRunning:()=>a.exitCode===null})}function l(h){p(`Error: 
${h.toString()}`),clearTimeout(w),e.onError?.(h)}function _(){p("Closed"),clearTimeout(w),e.onClose?.()}function u(h){let E=h.toString();p(`stdout: 
${E}`),c("out",E),e.onStdout?.(E)}function g(h){let E=h.toString();p(`stderr: ${E}`),c("error",E),e.onStderr?.(E)}function d(){a.off("spawn",f),a.off("error",l),a.off("close",_),a.stdout.off("data",u),a.stderr.off("data",g)}function v(){return d(),!a.pid||!a.connected?!0:(p(`Killing R process ${a.pid}`),process.kill(a.pid))}let w=setTimeout(()=>{throw v(),new Error(`Starting backend server failed.
 Logs:
`+n)},e.timeout_ms??5e3)})}function Xe({pathToApp:t,onCrash:e,onInitiation:o,onReady:n,onFailToStart:r,onLogs:s}){let i="0.0.0.0",a=null;async function c(){o(),p();try{let f=await Ne(),l=await Te(f),_=new RegExp(`listening on .+${f}`,"i"),u=H("options(shiny.autoreload = TRUE)",`shiny::runApp(appDir = "${t}", port = ${f}, host = "${i}")`);return a=await Y(["--no-save","--no-restore","--silent","-e",u],{onStderr(g){_.test(g)&&n(l.toString()),s(g.split(`
`))},onClose:e,onError:e}),!0}catch{return r(),!1}}function p(){return a===null?!0:a.stop()}return{start:c,stop:p}}var y=S(require("vscode"));var K=S(require("vscode"));async function ze({uri:t,position:e=new K.Position(0,0),locations:o,multiple:n="gotoAndPeek",noResultsMessage:r}){await K.commands.executeCommand("editor.action.goToLocations",t,e,o,n,r)}async function Je({editor:t,snippet:e,below_line:o}){let n=t.document.validatePosition(new y.Position(o-1,1/0));await t.insertSnippet(new y.SnippetString(`
`+e),n)||y.window.showErrorMessage("Failed to add output scaffold")}function te({editor:t,selections:e}){let o=e.map(([n,r,s,i])=>{let a=new y.Position(n-1,r-1),c=new y.Position(s-1,i);return new y.Selection(a,c)});t.selection=o[0],t.revealRange(o[0])}async function et({editor:t,input:{inputId:e}}){let o=`input$${e}`,n=o,s=t.document.getText().split(`
`),i=new RegExp(`(?<!#.*)${Ut(n)}(?=\\W)`),a=s.map((p,f)=>({line:f,match:i.exec(p)})).filter(({match:p})=>p!==null);if(a.length===0)return null;let c=a.map(({line:p,match:f})=>{let l=f?.index??0,_=new y.Position(p,l),u=new y.Position(p,l+n.length);return new y.Location(t.document.uri,new y.Range(_,u))});y.window.showTextDocument(t.document),await ze({uri:t.document.uri,locations:c,noResultsMessage:`Failed to find any current use of ${o} in server`})}function Ut(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var D=S(require("vscode"));async function tt({script_text:t,document:e}){let o=e.getText();if(t===o)return!1;let n=e.uri,r=new D.WorkspaceEdit,s=e.validateRange(new D.Selection(0,0,e.lineCount+1,0));return r.replace(n,s,t),await D.workspace.applyEdit(r),e.save(),!0}var{showErrorMessage:ot}=nt.window;function rt({RProcess:t,document:e,sendMessage:o}){let n=!1,r=null,s,i=async()=>{let u=e.getText();if(!(r!==null&&u.includes(r))){if(!n){let d=await Ee(t,"shinyuieditor");if(d.status==="error")throw o({path:"BACKEND-ERROR",payload:{context:"checking for shinyuieditor package",msg:d.msg}}),ot(d.msg),new Error(d.msg);n=!0}if(u===""){o({path:"TEMPLATE_CHOOSER",payload:"SINGLE-FILE"});return}try{let d=await X(t,u);if(d.status==="error"){o({path:"BACKEND-ERROR",payload:{context:"parsing app",msg:d.errorMsg}}),ot(d.errorMsg);return}if(d.values==="EMPTY"){o({path:"TEMPLATE_CHOOSER",payload:"SINGLE-FILE"});return}r=u,o({path:"APP-INFO",payload:{app_type:"SINGLE-FILE",app:{script:u,ast:d.values}}})}catch(d){console.error("Failed to parse",d)}}},a=de(i,500),c=()=>{a()},p=()=>{a.flush()},f=Xe({pathToApp:e.fileName,onInitiation:()=>{o({path:"APP-PREVIEW-STATUS",payload:"LOADING"})},onReady:u=>{o({path:"APP-PREVIEW-STATUS",payload:{url:u}})},onFailToStart:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Failed to start"})},onCrash:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Crashed"})},onLogs:u=>{o({path:"APP-PREVIEW-LOGS",payload:u})}}),l=async()=>(s=await ve({appFile:e,existingEditor:s}),s);return{onDocumentChanged:c,onDocumentSaved:p,onDidReceiveMessage:async u=>{if(le(u))switch(u.path){case"READY-FOR-STATE":i();return;case"UPDATED-APP":{if(u.payload.app_type==="MULTI-FILE")return;await tt({script_text:u.payload.app,document:e})&&(r=u.payload.app);return}case"APP-PREVIEW-REQUEST":{f.start();return}case"APP-PREVIEW-STOP":{f.stop();return}case"APP-PREVIEW-RESTART":{f.start();return}case"ENTERED-TEMPLATE-SELECTOR":{f.stop(),await he(e);return}case"OPEN-COMPANION-EDITOR":{await l();return}case"SHOW-APP-LINES":{te({editor:await l(),selections:u.payload});return}case"INSERT-SNIPPET":{console.log("Insert snippet into server",u.payload),Je({editor:await l(),...u.payload});return}case"FIND-SERVER-USES":{if(u.payload.type==="Input")et({editor:await l(),input:u.payload});else{let g=await X(t,e.getText());if(g.status==="success"&&g.values!=="EMPTY"){let d=_e(g.values);te({editor:await l(),selections:d.get_output_position(u.payload.outputId)??[]})}}return}case"NODE-SELECTION":{console.log("New node selection",u.payload);return}default:console.warn("Unhandled message from client",u)}else console.log("Unknown message from webview",u)}}}function st(t){let e=t.getText();return e.trim()===""?"empty":Gt.test(e)?"valid":"invalid"}var Gt=/shinyApp\(/;var it="SUE_START_SIGNAL",at="SUE_END_SIGNAL";async function pt(t,e,{timeout_ms:o=1e3,verbose:n=!1}={}){let r=c=>{n&&console.log(`runRCommand: ${c}`)},s="",i=!1,a=[];return t.exitCode!==null?{status:"error",errorMsg:`Can't run R command as background R process has exited with code ${t.exitCode}.`}:new Promise(c=>{function p(g){let v=g.toString().split(`
`);r("~~~Output chunk~~~");for(let w of v){let h=w.includes(it),E=w.includes(at),F=w.length===0;if(h){i=!0;continue}if(E){clearTimeout(_),c({status:"success",values:a}),r("Output finished"),u();break}!i||F||(r(w),s+=w+`
`,a.push(w))}}function f(g){let d=g.toString();s+=`stderr: ${d}
`,r("stderr: "+d)}function l(){c({status:"error",errorMsg:s}),u()}t.stdout.on("data",p),t.stderr.on("data",f),t.on("close",l);let _=setTimeout(()=>{c({status:"error",errorMsg:`Timeout, no response from run command within ${o}ms: ${e}
 Logs:
 ${s}`}),u()},o);function u(){t.stdout.off("data",p),t.stderr.off("data",f),t.off("close",l)}ut(`print('${it}');${e};print('${at}')`,t)})}async function ct(){async function t(){return await Y(["--silent","--slave","--no-save","--no-restore"],{timeout_ms:5e3})}let e=await t();return{...e,async runCmd(o,n){return e.getIsRunning()||(console.warn("Background R Process has crashed. Restarting..."),e.stop(),e=await t(),console.warn("Background R Process restarted")),pt(e.proc,o,n)}}}function ut(t,e){e.stdin.write(`${t}
`)}function lt(){let t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<32;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}var q=class{constructor(e){this.context=e;this.RProcess=null;ct().then(o=>{this.RProcess=o})}static register(e){let o=new q(e);return T.window.registerCustomEditorProvider(q.viewType,o,{webviewOptions:{retainContextWhenHidden:!0}})}async resolveCustomTextEditor(e,o,n){if(st(e)==="invalid"){let p="The active file doesn't appear to be a Shiny app. Make sure that the script is either empty or has a valid shiny app in it.";throw T.window.showErrorMessage(p),o.dispose(),new Error(p)}if(o.webview.options={enableScripts:!0},o.webview.html=this.getHtmlForWebview(o.webview),!this.RProcess)throw new Error("Don't have an R Process to pass to editor backend!");let s=rt({RProcess:this.RProcess,document:e,sendMessage:p=>o.webview.postMessage(p)}),i=T.workspace.onDidChangeTextDocument(p=>{p.document.uri.toString()===e.uri.toString()&&s.onDocumentChanged()}),a=T.workspace.onDidSaveTextDocument(p=>{p.uri.toString()===e.uri.toString()&&s.onDocumentSaved()}),c=o.webview.onDidReceiveMessage(s.onDidReceiveMessage);o.onDidDispose(()=>{i.dispose(),a.dispose(),c.dispose()})}getHtmlForWebview(e){let o=e.asWebviewUri(T.Uri.joinPath(this.context.extensionUri,"media","build","extension-editor.js")),n=e.asWebviewUri(T.Uri.joinPath(this.context.extensionUri,"media","build","style.css")),r=lt(),s=e.cspSource;return`
			<!DOCTYPE html>
			<html lang="en">
			<head>
				<meta charset="UTF-8">
				<script>
				// This is needed for various older packages that require the global
				// object to be defined because it typically was with older bundlers like
				// webpack
				var global = window;
			  </script>
				<!--
				Use a content security policy to only allow loading images from https or from our extension directory,
				and only allow scripts that have a specific nonce.
				-->
				<meta 
          http-equiv="Content-Security-Policy" 
          content="default-src 'none'; frame-src http://localhost:*/ ${s} https:; img-src ${s} data:; style-src ${e.cspSource} 'unsafe-inline'; script-src 'nonce-${r}';">

				<meta name="viewport" content="width=device-width, initial-scale=1.0">

				
				<link href="${n}" rel="stylesheet" />
				
				<title>Shiny UI Editor</title>
			</head>
			<body style="padding-inline: 0;">
				<noscript>You need to enable JavaScript to run this app.</noscript>
				<div id="root" style="height: 100vh; display: relative"></div>
				<script type="module" nonce="${r}" src="${o}"></script>
			</body>
			</html>`}},G=q;G.viewType="shinyuieditor.appFile";function Ft(t){t.subscriptions.push(G.register(t)),t.subscriptions.push(oe.commands.registerCommand("shinyuieditor.startEditorOnActiveFile",ue),oe.commands.registerCommand("shinyuieditor.launchEditor",ie))}0&&(module.exports={activate});
