"use strict";var tt=Object.create;var W=Object.defineProperty;var ot=Object.getOwnPropertyDescriptor;var rt=Object.getOwnPropertyNames;var nt=Object.getPrototypeOf,it=Object.prototype.hasOwnProperty;var st=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),at=(t,e)=>{for(var o in e)W(t,o,{get:e[o],enumerable:!0})},se=(t,e,o,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of rt(e))!it.call(t,n)&&n!==o&&W(t,n,{get:()=>e[n],enumerable:!(r=ot(e,n))||r.enumerable});return t};var T=(t,e,o)=>(o=t!=null?tt(nt(t)):{},se(e||!t||!t.__esModule?W(o,"default",{value:t,enumerable:!0}):o,t)),pt=t=>se(W({},"__esModule",{value:!0}),t);var Ne=st((Vt,be)=>{var ee=require("util"),mt=require("path"),O=require("child_process").spawn,y=function(){},te="HKLM",ye="HKCU",Re="HKCR",we="HKU",Te="HKCC",_e=[te,ye,Re,we,Te],Se="REG_SZ",Pe="REG_MULTI_SZ",xe="REG_EXPAND_SZ",Ae="REG_DWORD",Ce="REG_QWORD",Oe="REG_BINARY",Ue="REG_NONE",De=[Se,Pe,xe,Ae,Ce,Oe,Ue],ht="",gt=/(\\[a-zA-Z0-9_\s]+)*/,Et=/^(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER|HKEY_CLASSES_ROOT|HKEY_USERS|HKEY_CURRENT_CONFIG)(.*)$/,Me=/^(.*)\s(REG_SZ|REG_MULTI_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_NONE)\s+([^\s].*)$/;function F(t,e){if(!(this instanceof F))return new F(t,e);Error.captureStackTrace(this,F),this.__defineGetter__("name",function(){return F.name}),this.__defineGetter__("message",function(){return t}),this.__defineGetter__("code",function(){return e})}ee.inherits(F,Error);function U(t){var e={stdout:"",stderr:""};return t.stdout.on("data",function(o){e.stdout+=o.toString()}),t.stderr.on("data",function(o){e.stderr+=o.toString()}),e}function D(t,e,o){var r=o.stdout.trim(),n=o.stderr.trim(),i=ee.format(`%s command exited with code %d:
%s
%s`,t,e,r,n);return new F(i,e)}function vt(t){if(t=="x64")return"64";if(t=="x86")return"32";throw new Error("illegal architecture: "+t+" (use x86 or x64)")}function M(t,e){e&&t.push("/reg:"+vt(e))}function b(){return process.platform==="win32"?mt.join(process.env.windir,"system32","reg.exe"):"REG"}function $(t,e,o,r,n,i,s){if(!(this instanceof $))return new $(t,e,o,r,n,i,s);var a=t,p=e,c=o,d=r,l=n,g=i,u=s;this.__defineGetter__("host",function(){return a}),this.__defineGetter__("hive",function(){return p}),this.__defineGetter__("key",function(){return c}),this.__defineGetter__("name",function(){return d}),this.__defineGetter__("type",function(){return l}),this.__defineGetter__("value",function(){return g}),this.__defineGetter__("arch",function(){return u})}ee.inherits($,Object);function h(t){if(!(this instanceof h))return new h(t);var e=t||{},o=""+(e.host||""),r=""+(e.hive||te),n=""+(e.key||""),i=e.arch||null;if(this.__defineGetter__("host",function(){return o}),this.__defineGetter__("hive",function(){return r}),this.__defineGetter__("key",function(){return n}),this.__defineGetter__("path",function(){return(o.length==0?"":"\\\\"+o+"\\")+r+n}),this.__defineGetter__("arch",function(){return i}),this.__defineGetter__("parent",function(){var s=n.lastIndexOf("\\");return new h({host:this.host,hive:this.hive,key:s==-1?"":n.substring(0,s),arch:this.arch})}),_e.indexOf(r)==-1)throw new Error("illegal hive specified.");if(!gt.test(n))throw new Error("illegal key specified.");if(i&&i!="x64"&&i!="x86")throw new Error("illegal architecture specified (use x86 or x64)")}h.HKLM=te;h.HKCU=ye;h.HKCR=Re;h.HKU=we;h.HKCC=Te;h.HIVES=_e;h.REG_SZ=Se;h.REG_MULTI_SZ=Pe;h.REG_EXPAND_SZ=xe;h.REG_DWORD=Ae;h.REG_QWORD=Ce;h.REG_BINARY=Oe;h.REG_NONE=Ue;h.REG_TYPES=De;h.DEFAULT_VALUE=ht;h.prototype.values=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];M(o,this.arch);var r=O(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n="",i=this,s=null,a=U(r);return r.on("close",function(p){if(!s)if(p!==0)y("process exited with code "+p),e(D("QUERY",p,a),null);else{for(var c=[],d=[],l=n.split(`
`),g=0,u=0,f=l.length;u<f;u++){var v=l[u].trim();v.length>0&&(y(v),g!=0&&c.push(v),++g)}for(var u=0,f=c.length;u<f;u++){var m=Me.exec(c[u]),R,P,E;m&&(R=m[1].trim(),P=m[2].trim(),E=m[3],d.push(new $(i.host,i.hive,i.key,R,P,E,i.arch)))}e(null,d)}}),r.stdout.on("data",function(p){n+=p.toString()}),r.on("error",function(p){s=p,e(p)}),this};h.prototype.keys=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];M(o,this.arch);var r=O(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n="",i=this,s=null,a=U(r);return r.on("close",function(p){s||p!==0&&(y("process exited with code "+p),e(D("QUERY",p,a),null))}),r.stdout.on("data",function(p){n+=p.toString()}),r.stdout.on("end",function(){for(var p=[],c=[],d=n.split(`
`),l=0,g=d.length;l<g;l++){var u=d[l].trim();u.length>0&&(y(u),p.push(u))}for(var l=0,g=p.length;l<g;l++){var f=Et.exec(p[l]),v,m;f&&(v=f[1],m=f[2],m&&m!==i.key&&c.push(new h({host:i.host,hive:i.hive,key:m,arch:i.arch})))}e(null,c)}),r.on("error",function(p){s=p,e(p)}),this};h.prototype.get=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var r=["QUERY",this.path];e==""?r.push("/ve"):r=r.concat(["/v",e]),M(r,this.arch);var n=O(b(),r,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),i="",s=this,a=null,p=U(n);return n.on("close",function(c){if(!a)if(c!==0)y("process exited with code "+c),o(D("QUERY",c,p),null);else{for(var d=[],l=null,g=i.split(`
`),u=0,f=0,v=g.length;f<v;f++){var m=g[f].trim();m.length>0&&(y(m),u!=0&&d.push(m),++u)}var R=d[d.length-1]||"",P=Me.exec(R),E,w,A;P&&(E=P[1].trim(),w=P[2].trim(),A=P[3],l=new $(s.host,s.hive,s.key,E,w,A,s.arch)),o(null,l)}}),n.stdout.on("data",function(c){i+=c.toString()}),n.on("error",function(c){a=c,o(c)}),this};h.prototype.set=function(e,o,r,n){if(typeof n!="function")throw new TypeError("must specify a callback");if(De.indexOf(o)==-1)throw Error("illegal type specified.");var i=["ADD",this.path];e==""?i.push("/ve"):i=i.concat(["/v",e]),i=i.concat(["/t",o,"/d",r,"/f"]),M(i,this.arch);var s=O(b(),i,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),a=null,p=U(s);return s.on("close",function(c){a||(c!==0?(y("process exited with code "+c),n(D("ADD",c,p,null))):n(null))}),s.stdout.on("data",function(c){y(""+c)}),s.on("error",function(c){a=c,n(c)}),this};h.prototype.remove=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var r=e?["DELETE",this.path,"/f","/v",e]:["DELETE",this.path,"/f","/ve"];M(r,this.arch);var n=O(b(),r,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),i=null,s=U(n);return n.on("close",function(a){i||(a!==0?(y("process exited with code "+a),o(D("DELETE",a,s),null)):o(null))}),n.stdout.on("data",function(a){y(""+a)}),n.on("error",function(a){i=a,o(a)}),this};h.prototype.clear=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f","/va"];M(o,this.arch);var r=O(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,i=U(r);return r.on("close",function(s){n||(s!==0?(y("process exited with code "+s),e(D("DELETE",s,i),null)):e(null))}),r.stdout.on("data",function(s){y(""+s)}),r.on("error",function(s){n=s,e(s)}),this};h.prototype.erase=h.prototype.clear;h.prototype.destroy=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f"];M(o,this.arch);var r=O(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,i=U(r);return r.on("close",function(s){n||(s!==0?(y("process exited with code "+s),e(D("DELETE",s,i),null)):e(null))}),r.stdout.on("data",function(s){y(""+s)}),r.on("error",function(s){n=s,e(s)}),this};h.prototype.create=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["ADD",this.path,"/f"];M(o,this.arch);var r=O(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,i=U(r);return r.on("close",function(s){n||(s!==0?(y("process exited with code "+s),e(D("ADD",s,i),null)):e(null))}),r.stdout.on("data",function(s){y(""+s)}),r.on("error",function(s){n=s,e(s)}),this};h.prototype.keyExists=function(e){return this.values(function(o,r){if(o)return o.code==1?e(null,!1):e(o);e(null,!0)}),this};h.prototype.valueExists=function(e,o){return this.get(e,function(r,n){if(r)return r.code==1?o(null,!1):o(r);o(null,!0)}),this};be.exports=h});var Ut={};at(Ut,{activate:()=>Ot});module.exports=pt(Ut);var ie=T(require("vscode"));var C=require("vscode"),_=T(require("vscode"));var X="app.R",ct=/^([\w|\s]+)([\.[\w|^\.]*]*)$/i;function z(t){if(t==="")return{valid:!0,name:X};let e=t.match(ct);if(e===null)return{valid:!1,msg:`Invalid app name: ${t}.`};let[o,r,n]=e;return(n===""||n===".")&&(n=".R"),r?n!==".R"?{valid:!1,msg:`Invalid file extension: ${n}. Extension needs to be .R`}:(r=r.replaceAll(" ","-"),{valid:!0,name:`${r}${n}`}):{valid:!1,msg:`Invalid app name: ${t}. Make sure to only use numbers and letters. Spaces will be converted to dashes.`}}var ae=new TextEncoder().encode("");async function pe(){let t=await C.window.showOpenDialog({canSelectFolders:!0,canSelectFiles:!0,title:"Choose location for Shiny app",openLabel:"Choose app folder or file",canSelectMany:!1,filters:{"R scripts":["R","r"]}});if(!t)return;let e=t[0],r=(await _.workspace.fs.stat(e)).type===_.FileType.Directory?await ut(e):e;!r||_.commands.executeCommand("vscode.openWith",r,"shinyuieditor.appFile")}async function ut(t){let e=(await C.workspace.fs.readDirectory(t)).filter(([s,a])=>a===_.FileType.File).map(([s,a])=>s),o=await C.window.showInputBox({prompt:"Enter file name for new app",placeHolder:X,validateInput(s){let a=z(s);return a.valid?e.includes(a.name)?{message:`Run the editor on existing app: ${a.name}.`,severity:_.InputBoxValidationSeverity.Info}:{message:`Run the template chooser to build new app: ${a.name}.`,severity:_.InputBoxValidationSeverity.Info}:{message:a.msg,severity:_.InputBoxValidationSeverity.Error}}});if(!o)return;let r=z(o);if(!r.valid){_.window.showErrorMessage(`Error processing requested file name: ${o}. Try with a different name.`);return}let n=C.Uri.joinPath(t,r.name);return e.includes(r.name)||await C.workspace.fs.writeFile(n,ae),n}var ce=T(require("path")),ue=T(require("vscode")),H=require("vscode");function lt(t){let e=t.ext;return/\.R/i.test(e)}function le(t="world"){let e=H.window.activeTextEditor;if(!e){H.window.showErrorMessage("No active file open to run ui editor on!");return}let o=ce.default.parse(e.document.fileName);if(!lt(o)){H.window.showErrorMessage(`Can't run the ui editor on the currently active file ${o.base}, needs to be a .R file.`);return}ue.commands.executeCommand("vscode.openWith",e.document.uri,"shinyuieditor.appFile")}var x=T(require("vscode"));function dt(t){return typeof t=="object"&&t!==null}function de(t){return dt(t)?"path"in t:!1}var fe=ft;function ft(t,e,o){var r=null,n=null,i=function(){r&&(clearTimeout(r),n=null,r=null)},s=function(){var p=n;i(),p&&p()},a=function(){if(!e)return t.apply(this,arguments);var p=this,c=arguments,d=o&&!r;if(i(),n=function(){t.apply(p,c)},r=setTimeout(function(){if(r=null,!d){var l=n;return n=null,l()}},e),d)return n()};return a.cancel=i,a.flush=s,a}var Ve=T(require("vscode"));var N=T(require("vscode"));var me=T(require("vscode"));function j({start:t,end:e}){return new me.Selection(t-1,0,e,0)}async function K({text:t,document:e,uiBounds:o={start:0,end:0},type:r}){let n=e.uri,i=new N.WorkspaceEdit;if(r==="replace"){let s=j(o);i.replace(n,s,t)}r==="insert"&&i.insert(e.uri,new N.Position(0,0),t),await N.workspace.applyEdit(i),e.save()}var I=T(require("vscode"));async function he(t){let e=t.uri,o=new I.WorkspaceEdit,r=t.validateRange(new I.Range(0,0,1/0,1/0));o.replace(e,r,""),await I.workspace.applyEdit(o),t.save()}var L=T(require("vscode"));async function ge({appFile:t,existingEditor:e}){return e&&L.window.visibleTextEditors.includes(e)?e:await L.window.showTextDocument(t.uri,{viewColumn:L.ViewColumn.Beside,preview:!0})}function Ee(t,e){e.selection=j(t)}var ke=require("child_process");var re=require("fs"),ne=T(require("path")),G=T(require("vscode"));function S(...t){return t.filter(o=>o!==void 0).reduce((o,r,n)=>(n===0?"":o+`
`)+r,"")}function k(t){return t.replace(/"/g,'\\"')}function ve(t){return t.replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}var Ie=Ne();function yt(t){let e=":",o="";t==="win32"&&(e=";",o=".exe");let r=process.env.PATH?process.env.PATH.split(e):[];for(let n of r){let i=ne.default.join(n,"R"+o);if((0,re.existsSync)(i))return i}return""}async function Rt(){let t=process.platform,e=yt(t);if(!e&&t==="win32")try{let o=new Ie({hive:Ie.HKLM,key:"\\Software\\R-Core\\R"}),r=await new Promise((n,i)=>o.get("InstallPath",(s,a)=>s===null?n(a):i(s)));e=ne.default.join(r.value,"bin","R.exe")}catch{e=""}return e}function oe(){return`rpath.${process.platform==="win32"?"windows":process.platform==="darwin"?"mac":"linux"}`}function wt(){let t=oe();return G.workspace.getConfiguration("shinyuieditor").get(t)}async function V(){let t=wt();if(t||(t=await Rt()),!t){let e=`Cannot find R for running shinyuieditor. Make sure R is installed and/or updating the shinyuieditor.${oe()} config option to proper to R path.`;throw G.window.showErrorMessage(e),new Error(e)}if(!(0,re.existsSync)(t)){let e=`Path to R is invalid: ${t}. Make sure R is installed and/or updating the shinyuieditor.${oe()} config option to proper to R path.`;throw G.window.showErrorMessage(e),new Error(e)}return ve(t)}async function Y(t,{verbose:e=!1,timeout_ms:o=1500}){let r=Tt(e,"runRCommand: "),n=await V();return n?new Promise(i=>{let s=[],a=[],p=(0,ke.spawn)(n,["-e",t,"--silent","--slave"]);function c(){r("Spawned")}function d(m){r("Error "+m.message),f(),i({status:"error",errorMsgs:a.join(`
`)})}function l(){r("Close"),f(),i({status:"success",values:s})}function g(m){r(`stdout: ${m.toString()}`),s.push(m.toString())}function u(m){r(`stderr: ${m.toString()}`),a.push(m.toString())}function f(){clearTimeout(v),p.off("spawn",c),p.off("error",d),p.off("close",l),p.stdout.off("data",g),p.stderr.off("data",u)}let v=setTimeout(()=>{console.log("Timeout"),i({status:"error",errorMsgs:`Command, no response from run command within ${o}ms:
${t}`}),f()},o);p.on("spawn",c),p.on("error",d),p.on("close",l),p.stdout.on("data",g),p.stderr.on("data",u)}):{status:"error",errorMsgs:"Failed to start find R binary"}}function Tt(t,e){return o=>{t&&console.log(e+o)}}async function Fe(t,e){let o=await Y(`print(require(${e}, quietly = TRUE))`,{verbose:!1});return o.status==="error"||o.values[0].includes("FALSE")?{status:"error",msg:_t(e)}:{status:"success"}}function _t(t){return`The ShinyUiEditor extension needs the \`${t}\` pkg installed. Install using \`remotes::install_github('rstudio/${t}')\` and restart the extension.`}async function Le(t,e,o){return(await t.runCmd(`styler::style_text("${k(e)}", scope = "tokens")`,o)).reduce((n,i)=>n+`
`+i,"")}async function Q(t,e){let o=St(t);try{let r=await e.runCmd(o,{verbose:!1});return JSON.parse(S(...r))}catch{throw new Error("Failed to generate new ui code from tree")}}function St(t,e=!0){let o=k(JSON.stringify(t,null,2)),r=e?"TRUE":"FALSE";return S("ui_tree <- jsonlite::fromJSON(",`  txt = "${o}",`,"  simplifyVector = FALSE",")",`new_ui_code <- shinyuieditor:::ui_tree_to_code(ui_tree, remove_namespace = ${r})`,"new_ui_code$text <- as.character(new_ui_code$text)","jsonlite::toJSON(new_ui_code, auto_unbox = TRUE)")}async function $e(t,{uiTree:e,otherCode:{uiExtra:o,serverFunctionBody:r,serverExtra:n,serverLibraries:i}}){let{text:s,namespaces_removed:a}=await Q(e,t),c=[...new Set([...i!=null?i:[],...a])].map(f=>`library(${f})`),d=["server <- function(input, output) {",r,"}"],l="ui <- "+S(...s),g=S(...c,o,"",l,"",n,"",...d,"","shinyApp(ui, server)");return await Le(t,g)}async function Ge(t){console.log("Running getAppFile()");let e=Pt(t),o=await Y(e,{verbose:!1});if(o.status==="error")throw new Error(`Error parsing app file: ${o.errorMsgs}`);try{let r=JSON.parse(o.values.reduce((n,i)=>n+`
`+i,""));return Object.keys(r).length===0?"EMPTY":r}catch{throw new Error("Could not get document as json. Content is not valid json")}}function Pt(t){let e=k(t);return S(`app_lines <- strsplit("${e}", "\\n")[[1]]`,"jsonlite::toJSON(",'  shinyuieditor:::get_file_ui_definition_info(app_lines, "SINGLE-FILE"),',"  auto_unbox = TRUE",")")}var q=T(require("vscode"));var Be=T(require("net"));async function We(){return new Promise(t=>{let e=Be.default.createServer();e.listen(0,()=>{var r;let o=(r=e.address)==null?void 0:r.call(e);if(typeof o=="string"||o===null)throw new Error("Failed to find a free port...");e.close(n=>t(o.port))})})}var He=require("child_process");async function Z(t,e={}){let o=await V();if(o===void 0)throw new Error("Can't get R path");let r="";return new Promise(n=>{var P;let i=new AbortController,{signal:s}=i,a=(0,He.spawn)(o,t,{signal:s});a.on("spawn",d),a.on("error",l),a.on("close",g),a.stdout.on("data",u),a.stderr.on("data",f);function p(E,w){r+=`${E}: ${w}`}function c(E){!e.verbose||console.log(`%c[RProc ${a.pid}] %c${E.replaceAll(/\n$/g,"").replaceAll(/\n/g,`
\u2219\u2219\u2219 `)}`,"color: orangered;","color: grey; opacity: 0.5")}function d(){c("spawned"),clearTimeout(R),n({proc:a,stop:m})}function l(E){var w;c(`Error: 
${E.toString()}`),clearTimeout(R),(w=e.onError)==null||w.call(e,E)}function g(){var E;c("Closed"),clearTimeout(R),(E=e.onClose)==null||E.call(e)}function u(E){var A;let w=E.toString();c(`stdout: 
${w}`),p("out",w),(A=e.onStdout)==null||A.call(e,w)}function f(E){var A;let w=E.toString();c(`stderr: ${w}`),p("error",w),(A=e.onStderr)==null||A.call(e,w)}function v(){a.off("spawn",d),a.off("error",l),a.off("close",g),a.stdout.off("data",u),a.stderr.off("data",f)}function m(){return v(),!a.pid||!a.connected?!0:(c(`Killing R process ${a.pid}`),process.kill(a.pid))}let R=setTimeout(()=>{throw m(),new Error(`Starting backend server failed.
 Logs:
`+r)},(P=e.timeout_ms)!=null?P:5e3)})}function je({pathToApp:t,onCrash:e,onInitiation:o,onReady:r,onFailToStart:n,onLogs:i}){let s="0.0.0.0",a=null;async function p(){o(),c();try{let d=await We(),l=await q.env.asExternalUri(q.Uri.parse(`http://localhost:${d}`)),g=new RegExp(`listening on .+${d}`,"i"),u=S("options(shiny.autoreload = TRUE)",`shiny::runApp(appDir = "${t}", port = ${d}, host = "${s}")`);return a=await Z(["--no-save","--no-restore","--silent","-e",u],{onStderr(f){g.test(f)&&r(l.toString()),i(f.split(`
`))},onClose:e,onError:e}),!0}catch{return n(),!1}}function c(){return a===null?!0:a.stop()}return{start:p,stop:c}}async function Ke({document:t,uiBounds:e,RProcess:o,uiTree:r}){if(!e)throw new Error("Attempting to update an app that has yet to be parsed.");let{start:n,end:i}=e,s=await Q(r,o),a=`ui <- ${S(...s.text)}
`;await K({text:a,document:t,uiBounds:e,type:"replace"});let p=i-n+1,d=s.text.length-p;return{uiText:a,uiBounds:{start:n,end:i+d}}}var{showErrorMessage:xt}=Ve.window;function Ye({RProcess:t,document:e,sendMessage:o}){let r=!1,n=null,i,s,a=async()=>{let u=e.getText();if(n!==null&&u.includes(n))return;if(!r){let m=await Fe(t,"shinyuieditor");if(m.status==="error")throw o({path:"BACKEND-ERROR",payload:m.msg}),xt(m.msg),new Error(m.msg);r=!0}let v=await Ge(u);if(v==="EMPTY")o({path:"TEMPLATE_CHOOSER",payload:"SINGLE-FILE"});else{let{ui_tree:m}=v;i=v.ui_bounds,o({path:"UPDATED-TREE",payload:m})}},p=fe(a,500),c=()=>{p()},d=()=>{p.flush()},l=je({pathToApp:e.fileName,onInitiation:()=>{o({path:"APP-PREVIEW-STATUS",payload:"LOADING"})},onReady:u=>{o({path:"APP-PREVIEW-STATUS",payload:{url:u}})},onFailToStart:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Failed to start"})},onCrash:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Crashed"})},onLogs:u=>{o({path:"APP-PREVIEW-LOGS",payload:u})}});return{onDocumentChanged:c,onDocumentSaved:d,onDidReceiveMessage:async u=>{if(de(u))switch(u.path){case"READY-FOR-STATE":a();return;case"TEMPLATE-SELECTION":{let f=await $e(t,u.payload);await K({text:f,document:e,type:"insert",uiBounds:i});return}case"UPDATED-TREE":{let f=await Ke({document:e,uiBounds:i,RProcess:t,uiTree:u.payload});n=f.uiText,i=f.uiBounds;return}case"APP-PREVIEW-REQUEST":{l.start();return}case"APP-PREVIEW-STOP":{l.stop();return}case"APP-PREVIEW-RESTART":{l.start();return}case"ENTERED-TEMPLATE-SELECTOR":{l.stop(),await he(e);return}case"OPEN-COMPANION-EDITOR":{s=await ge({appFile:e,existingEditor:s}),i&&Ee(i,s);return}case"NODE-SELECTION":{console.log("New node selection",u.payload);return}default:console.warn("Unhandled message from client",u)}else console.log("Unknown message from webview",u)}}}function Qe(t){let e=t.getText();return e.trim()===""?"empty":At.test(e)?"valid":"invalid"}var At=/shinyApp\(/;var Ze="SUE_START_SIGNAL",qe="SUE_END_SIGNAL";function Ct(t,e){return o=>{t&&console.log(e+o)}}async function Je(t,e,{timeout_ms:o=1e3,verbose:r=!1}={}){let n=Ct(r,"runRCommand: "),i="",s=!1,a=!1,p=[];return new Promise(c=>{function d(f){let m=f.toString().split(`
`);n("~~~Output chunk~~~");for(let R of m){if(i+=R+`
`,n(R),R.includes(Ze)){a=!0;continue}if(!!a&&!(!s&&R.length===0)){if(R.includes(qe)){clearTimeout(u),c(p),n("Output finished"),g();break}s=!0,p.push(R)}}}function l(f){n("stderr: "+f.toString())}function g(){t.stdout.off("data",d),t.stderr.off("data",l)}t.stdout.on("data",d),t.stderr.on("data",l);let u=setTimeout(()=>{throw g(),new Error(`Timeout, no response from run command within ${o}ms: ${e}
 Logs:
 ${i}`)},o);Xe(`print('${Ze}');${e};print('${qe}')`,t)})}async function ze(){let t=await Z(["--silent","--slave","--no-save","--no-restore"],{timeout_ms:5e3});return{...t,runCmd:(e,o)=>Je(t.proc,e,o)}}function Xe(t,e){e.stdin.write(`${t}
`)}function et(){let t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<32;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}var J=class{constructor(e){this.context=e;this.RProcess=null;ze().then(o=>{this.RProcess=o})}static register(e){let o=new J(e);return x.window.registerCustomEditorProvider(J.viewType,o,{webviewOptions:{retainContextWhenHidden:!0}})}async resolveCustomTextEditor(e,o,r){if(Qe(e)==="invalid"){let c="The active file doesn't appear to be a Shiny app. Make sure that the script is either empty or has a valid shiny app in it.";throw x.window.showErrorMessage(c),o.dispose(),new Error(c)}if(o.webview.options={enableScripts:!0},o.webview.html=this.getHtmlForWebview(o.webview),!this.RProcess)throw new Error("Don't have an R Process to pass to editor backend!");let i=Ye({RProcess:this.RProcess,document:e,sendMessage:c=>o.webview.postMessage(c)}),s=x.workspace.onDidChangeTextDocument(c=>{c.document.uri.toString()===e.uri.toString()&&i.onDocumentChanged()}),a=x.workspace.onDidSaveTextDocument(c=>{c.uri.toString()===e.uri.toString()&&i.onDocumentSaved()}),p=o.webview.onDidReceiveMessage(i.onDidReceiveMessage);o.onDidDispose(()=>{s.dispose(),a.dispose(),p.dispose()})}getHtmlForWebview(e){let o=e.asWebviewUri(x.Uri.joinPath(this.context.extensionUri,"media","build","bundle.js")),r=e.asWebviewUri(x.Uri.joinPath(this.context.extensionUri,"media","build","bundle.css")),n=et(),i=e.cspSource;return`
			<!DOCTYPE html>
			<html lang="en">
			<head>
				<meta charset="UTF-8">
				<script>
				// This is needed for various older packages that require the global
				// object to be defined because it typically was with older bundlers like
				// webpack
				var global = window;
			  <\/script>
				<!--
				Use a content security policy to only allow loading images from https or from our extension directory,
				and only allow scripts that have a specific nonce.
				-->
				<meta 
          http-equiv="Content-Security-Policy" 
          content="default-src 'none'; frame-src http://localhost:*/ ${i} https:; img-src ${i} data:; style-src ${e.cspSource} 'unsafe-inline'; script-src 'nonce-${n}';">

				<meta name="viewport" content="width=device-width, initial-scale=1.0">

				
				<link href="${r}" rel="stylesheet" />
				
				<title>Shiny UI Editor</title>
			</head>
			<body style="padding-inline: 0;">
				<noscript>You need to enable JavaScript to run this app.</noscript>
				<div id="root" style="height: 100vh; display: relative"></div>
				<script nonce="${n}" src="${o}"><\/script>
			</body>
			</html>`}},B=J;B.viewType="shinyuieditor.appFile";function Ot(t){t.subscriptions.push(B.register(t)),t.subscriptions.push(ie.commands.registerCommand("shinyuieditor.startEditorOnActiveFile",le),ie.commands.registerCommand("shinyuieditor.launchEditor",pe))}0&&(module.exports={activate});
