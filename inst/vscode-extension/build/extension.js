"use strict";var xe=Object.create;var D=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var Ue=Object.getPrototypeOf,be=Object.prototype.hasOwnProperty;var Me=(r,e)=>()=>(e||r((e={exports:{}}).exports,e),e.exports),Oe=(r,e)=>{for(var t in e)D(r,t,{get:e[t],enumerable:!0})},K=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Ce(e))!be.call(r,n)&&n!==t&&D(r,n,{get:()=>e[n],enumerable:!(o=Ae(e,n))||o.enumerable});return r};var b=(r,e,t)=>(t=r!=null?xe(Ue(r)):{},K(e||!r||!r.__esModule?D(t,"default",{value:r,enumerable:!0}):t,r)),ke=r=>K(D({},"__esModule",{value:!0}),r);var he=Me((st,fe)=>{var B=require("util"),We=require("path"),S=require("child_process").spawn,y=function(){},F="HKLM",z="HKCU",ee="HKCR",te="HKU",re="HKCC",oe=[F,z,ee,te,re],ne="REG_SZ",ie="REG_MULTI_SZ",se="REG_EXPAND_SZ",ae="REG_DWORD",ue="REG_QWORD",ce="REG_BINARY",pe="REG_NONE",le=[ne,ie,se,ae,ue,ce,pe],$e="",Be=/(\\[a-zA-Z0-9_\s]+)*/,Fe=/^(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER|HKEY_CLASSES_ROOT|HKEY_USERS|HKEY_CURRENT_CONFIG)(.*)$/,de=/^(.*)\s(REG_SZ|REG_MULTI_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_NONE)\s+([^\s].*)$/;function M(r,e){if(!(this instanceof M))return new M(r,e);Error.captureStackTrace(this,M),this.__defineGetter__("name",function(){return M.name}),this.__defineGetter__("message",function(){return r}),this.__defineGetter__("code",function(){return e})}B.inherits(M,Error);function x(r){var e={stdout:"",stderr:""};return r.stdout.on("data",function(t){e.stdout+=t.toString()}),r.stderr.on("data",function(t){e.stderr+=t.toString()}),e}function A(r,e,t){var o=t.stdout.trim(),n=t.stderr.trim(),s=B.format(`%s command exited with code %d:
%s
%s`,r,e,o,n);return new M(s,e)}function He(r){if(r=="x64")return"64";if(r=="x86")return"32";throw new Error("illegal architecture: "+r+" (use x86 or x64)")}function C(r,e){e&&r.push("/reg:"+He(e))}function U(){return process.platform==="win32"?We.join(process.env.windir,"system32","reg.exe"):"REG"}function O(r,e,t,o,n,s,i){if(!(this instanceof O))return new O(r,e,t,o,n,s,i);var c=r,a=e,p=t,d=o,u=n,f=s,h=i;this.__defineGetter__("host",function(){return c}),this.__defineGetter__("hive",function(){return a}),this.__defineGetter__("key",function(){return p}),this.__defineGetter__("name",function(){return d}),this.__defineGetter__("type",function(){return u}),this.__defineGetter__("value",function(){return f}),this.__defineGetter__("arch",function(){return h})}B.inherits(O,Object);function l(r){if(!(this instanceof l))return new l(r);var e=r||{},t=""+(e.host||""),o=""+(e.hive||F),n=""+(e.key||""),s=e.arch||null;if(this.__defineGetter__("host",function(){return t}),this.__defineGetter__("hive",function(){return o}),this.__defineGetter__("key",function(){return n}),this.__defineGetter__("path",function(){return(t.length==0?"":"\\\\"+t+"\\")+o+n}),this.__defineGetter__("arch",function(){return s}),this.__defineGetter__("parent",function(){var i=n.lastIndexOf("\\");return new l({host:this.host,hive:this.hive,key:i==-1?"":n.substring(0,i),arch:this.arch})}),oe.indexOf(o)==-1)throw new Error("illegal hive specified.");if(!Be.test(n))throw new Error("illegal key specified.");if(s&&s!="x64"&&s!="x86")throw new Error("illegal architecture specified (use x86 or x64)")}l.HKLM=F;l.HKCU=z;l.HKCR=ee;l.HKU=te;l.HKCC=re;l.HIVES=oe;l.REG_SZ=ne;l.REG_MULTI_SZ=ie;l.REG_EXPAND_SZ=se;l.REG_DWORD=ae;l.REG_QWORD=ue;l.REG_BINARY=ce;l.REG_NONE=pe;l.REG_TYPES=le;l.DEFAULT_VALUE=$e;l.prototype.values=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var t=["QUERY",this.path];C(t,this.arch);var o=S(U(),t,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n="",s=this,i=null,c=x(o);return o.on("close",function(a){if(!i)if(a!==0)y("process exited with code "+a),e(A("QUERY",a,c),null);else{for(var p=[],d=[],u=n.split(`
`),f=0,h=0,m=u.length;h<m;h++){var R=u[h].trim();R.length>0&&(y(R),f!=0&&p.push(R),++f)}for(var h=0,m=p.length;h<m;h++){var E=de.exec(p[h]),w,g,v;E&&(w=E[1].trim(),g=E[2].trim(),v=E[3],d.push(new O(s.host,s.hive,s.key,w,g,v,s.arch)))}e(null,d)}}),o.stdout.on("data",function(a){n+=a.toString()}),o.on("error",function(a){i=a,e(a)}),this};l.prototype.keys=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var t=["QUERY",this.path];C(t,this.arch);var o=S(U(),t,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n="",s=this,i=null,c=x(o);return o.on("close",function(a){i||a!==0&&(y("process exited with code "+a),e(A("QUERY",a,c),null))}),o.stdout.on("data",function(a){n+=a.toString()}),o.stdout.on("end",function(){for(var a=[],p=[],d=n.split(`
`),u=0,f=d.length;u<f;u++){var h=d[u].trim();h.length>0&&(y(h),a.push(h))}for(var u=0,f=a.length;u<f;u++){var m=Fe.exec(a[u]),R,E;m&&(R=m[1],E=m[2],E&&E!==s.key&&p.push(new l({host:s.host,hive:s.hive,key:E,arch:s.arch})))}e(null,p)}),o.on("error",function(a){i=a,e(a)}),this};l.prototype.get=function(e,t){if(typeof t!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];e==""?o.push("/ve"):o=o.concat(["/v",e]),C(o,this.arch);var n=S(U(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),s="",i=this,c=null,a=x(n);return n.on("close",function(p){if(!c)if(p!==0)y("process exited with code "+p),t(A("QUERY",p,a),null);else{for(var d=[],u=null,f=s.split(`
`),h=0,m=0,R=f.length;m<R;m++){var E=f[m].trim();E.length>0&&(y(E),h!=0&&d.push(E),++h)}var w=d[d.length-1]||"",g=de.exec(w),v,P,j;g&&(v=g[1].trim(),P=g[2].trim(),j=g[3],u=new O(i.host,i.hive,i.key,v,P,j,i.arch)),t(null,u)}}),n.stdout.on("data",function(p){s+=p.toString()}),n.on("error",function(p){c=p,t(p)}),this};l.prototype.set=function(e,t,o,n){if(typeof n!="function")throw new TypeError("must specify a callback");if(le.indexOf(t)==-1)throw Error("illegal type specified.");var s=["ADD",this.path];e==""?s.push("/ve"):s=s.concat(["/v",e]),s=s.concat(["/t",t,"/d",o,"/f"]),C(s,this.arch);var i=S(U(),s,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),c=null,a=x(i);return i.on("close",function(p){c||(p!==0?(y("process exited with code "+p),n(A("ADD",p,a,null))):n(null))}),i.stdout.on("data",function(p){y(""+p)}),i.on("error",function(p){c=p,n(p)}),this};l.prototype.remove=function(e,t){if(typeof t!="function")throw new TypeError("must specify a callback");var o=e?["DELETE",this.path,"/f","/v",e]:["DELETE",this.path,"/f","/ve"];C(o,this.arch);var n=S(U(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),s=null,i=x(n);return n.on("close",function(c){s||(c!==0?(y("process exited with code "+c),t(A("DELETE",c,i),null)):t(null))}),n.stdout.on("data",function(c){y(""+c)}),n.on("error",function(c){s=c,t(c)}),this};l.prototype.clear=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var t=["DELETE",this.path,"/f","/va"];C(t,this.arch);var o=S(U(),t,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,s=x(o);return o.on("close",function(i){n||(i!==0?(y("process exited with code "+i),e(A("DELETE",i,s),null)):e(null))}),o.stdout.on("data",function(i){y(""+i)}),o.on("error",function(i){n=i,e(i)}),this};l.prototype.erase=l.prototype.clear;l.prototype.destroy=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var t=["DELETE",this.path,"/f"];C(t,this.arch);var o=S(U(),t,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,s=x(o);return o.on("close",function(i){n||(i!==0?(y("process exited with code "+i),e(A("DELETE",i,s),null)):e(null))}),o.stdout.on("data",function(i){y(""+i)}),o.on("error",function(i){n=i,e(i)}),this};l.prototype.create=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var t=["ADD",this.path,"/f"];C(t,this.arch);var o=S(U(),t,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,s=x(o);return o.on("close",function(i){n||(i!==0?(y("process exited with code "+i),e(A("ADD",i,s),null)):e(null))}),o.stdout.on("data",function(i){y(""+i)}),o.on("error",function(i){n=i,e(i)}),this};l.prototype.keyExists=function(e){return this.values(function(t,o){if(t)return t.code==1?e(null,!1):e(t);e(null,!0)}),this};l.prototype.valueExists=function(e,t){return this.get(e,function(o,n){if(o)return o.code==1?t(null,!1):t(o);t(null,!0)}),this};fe.exports=l});var Ze={};Oe(Ze,{activate:()=>Qe});module.exports=ke(Ze);function De(r){return typeof r=="object"&&r!==null}function Y(r){return De(r)?"path"in r:!1}var V=Ne;function Ne(r,e,t){var o=null,n=null,s=function(){o&&(clearTimeout(o),n=null,o=null)},i=function(){var a=n;s(),a&&a()},c=function(){if(!e)return r.apply(this,arguments);var a=this,p=arguments,d=t&&!o;if(s(),n=function(){r.apply(a,p)},o=setTimeout(function(){if(o=null,!d){var u=n;return n=null,u()}},e),d)return n()};return c.cancel=s,c.flush=i,c}var _=b(require("vscode"));function T(...r){return r.reduce((e,t,o)=>(o===0?"":e+`
`)+t,"")}function N(r){return r.replace(/"/g,'\\"')}async function Q(r,e){let t=Ge(r);try{let o=await e.runCmd(t,{verbose:!1});return JSON.parse(T(...o))}catch{throw new Error("Failed to generate new ui code from tree")}}function Ge(r,e=!0){let t=N(JSON.stringify(r,null,2)),o=e?"TRUE":"FALSE";return T("ui_tree <- jsonlite::fromJSON(",`  txt = "${t}",`,"  simplifyVector = FALSE",")",`new_ui_code <- shinyuieditor:::ui_tree_to_code(ui_tree, remove_namespace = ${o})`,"new_ui_code$text <- as.character(new_ui_code$text)","jsonlite::toJSON(new_ui_code, auto_unbox = TRUE)")}async function Z(r,e){let t=Ie(r),o=await e.runCmd(t);try{let n=JSON.parse(o.reduce((s,i)=>s+`
`+i,""));return Object.keys(n).length===0?"EMPTY":n}catch{throw new Error("Could not get document as json. Content is not valid json")}}function Ie(r){let e=N(r);return T(`app_lines <- strsplit("${e}", "\\n")[[1]]`,"jsonlite::toJSON(",'  shinyuieditor:::get_file_ui_definition_info(app_lines, "single-file"),',"  auto_unbox = TRUE",")")}var J="SUE_START_SIGNAL",q="SUE_END_SIGNAL";function Le(r,e){return t=>{r&&console.log(e+t)}}async function X(r,e,{timeout_ms:t=1e3,verbose:o=!1}={}){let n=Le(o,"runRCommand: "),s="",i=!1,c=!1,a=[];return new Promise(p=>{function d(f){let h=f.toString().split(`
`);for(let m of h){if(s+=m+`
`,n(m),m.includes(J)){c=!0;continue}if(!!c&&!(!i&&m.length===0)){if(m.includes(q)){clearTimeout(u),p(a),n("Output finished"),r.stdout.off("data",d);break}i=!0,a.push(m)}}}r.stdout.on("data",d);let u=setTimeout(()=>{throw new Error(`Timeout, no response from run command within ${t}ms: ${e}
 Logs:
 ${s}`)},t);$(`print('${J}');${e};print('${q}')`,r)})}var ye=require("child_process");var Ee=require("fs"),H=b(require("path")),G=b(require("vscode")),me=he();function ge(){return G.workspace.getConfiguration("r")}function je(r){let e=":",t="";r==="win32"&&(e=";",t=".exe");let o=process.env.PATH?process.env.PATH.split(e):[];for(let n of o){let s=H.default.join(n,"R"+t);if((0,Ee.existsSync)(s))return s}return""}async function Ke(){let r="",e=process.platform;if(r||(r=je(e)),!r&&e==="win32")try{let t=new me({hive:me.HKLM,key:"\\Software\\R-Core\\R"}),o=await new Promise((n,s)=>t.get("InstallPath",(i,c)=>i===null?n(c):s(i)));r=H.default.join(o.value,"bin","R.exe")}catch{r=""}return r}function Ye(r=!1){let e=r?"rterm":"rpath",t=process.platform==="win32"?"windows":process.platform==="darwin"?"mac":"linux";return`${e}.${t}`}async function ve(r=!1,e){let t="";e&&(t=ge().get(e));let o=Ye();return t||(t=ge().get(o)),t||(t=await Ke()),t||(t=void 0),t?r&&/^[^'"].* .*[^'"]$/.exec(t)?t=`"${t}"`:r?process.platform==="win32"&&/^'.* .*'$/.exec(t)&&(t=t.replace(/^'(.*)'$/,'"$1"')):(t=t.replace(/^"(.*)"$/,"$1"),t=t.replace(/^'(.*)'$/,"$1")):G.window.showErrorMessage(`Cannot find R to use for help, package installation etc. Change setting r.${o} to R path.`),t}async function I(r,e={}){let t=await ve();if(t===void 0)throw new Error("Can't get R path");let o="";return new Promise(n=>{var w;let s=new AbortController,{signal:i}=s,c=g=>e.verbose?console.log(`%c[RProc ${a.pid}] %c${g.replaceAll(/\n$/g,"").replaceAll(/\n/g,`
\u2219\u2219\u2219 `)}`,"color: orangered;","color: grey; opacity: 0.5"):null,a=(0,ye.spawn)(t,r,{signal:i});function p(g,v){o+=`${g}: ${v}`}let d=()=>{c("spawned"),clearTimeout(E),n({proc:a,stop:R})},u=g=>{var v;c(`Error: 
${g.toString()}`),clearTimeout(E),(v=e.onError)==null||v.call(e,g)},f=()=>{var g;c("Closed"),clearTimeout(E),(g=e.onClose)==null||g.call(e)},h=g=>{var P;let v=g.toString();c(`stdout: 
${v}`),p("out",v),(P=e.onStdout)==null||P.call(e,v)},m=g=>{var P;let v=g.toString();c(`stderr: ${v}`),p("error",v),(P=e.onStderr)==null||P.call(e,v)};a.on("spawn",d),a.on("error",u),a.on("close",f),a.stdout.on("data",h),a.stderr.on("data",m);let R=()=>a.pid?(c(`Killing R process ${a.pid}`),a.off("spawn",d),a.off("error",u),a.off("close",f),a.stdout.off("data",h),a.stderr.off("data",m),process.kill(a.pid)):!0,E=setTimeout(()=>{throw new Error(`Starting backend server failed.
 Logs:
`+o)},(w=e.timeout_ms)!=null?w:5e3)})}async function Re(){let r=await I(["--silent","--slave","--no-save","--no-restore"],{timeout_ms:5e3});return console.log("R Process is active! Loading shinyuieditor library."),$("library(shinyuieditor)",r.proc),{...r,runCmd:(e,t)=>X(r.proc,e,t)}}function $(r,e){e.stdin.write(`${r}
`)}var Te=b(require("path")),L=b(require("vscode"));var _e=b(require("net"));async function we(){return new Promise(r=>{let e=_e.default.createServer();e.listen(0,()=>{var o;let t=(o=e.address)==null?void 0:o.call(e);if(typeof t=="string"||t===null)throw new Error("Failed to find a free port...");e.close(n=>r(t.port))})})}function Pe({pathToApp:r,onCrash:e,onInitiation:t,onReady:o,onFailToStart:n,onLogs:s}){let i="0.0.0.0",c=Te.default.parse(r).dir,a=null;async function p(){t(),d();try{let u=await we(),f=await L.env.asExternalUri(L.Uri.parse(`http://localhost:${u}`)),h=new RegExp(`listening on .+${u}`,"i"),m=T("options(shiny.autoreload = TRUE)",`shiny::runApp(appDir = "${c}", port = ${u}, host = "${i}")`);return a=await I(["--no-save","--no-restore","--silent","-e",m],{onStderr(R){h.test(R)&&o(f.toString()),s(R.split(`
`))},onClose:e,onError:e}),!0}catch{return n(),!1}}function d(){return a===null?!0:a.stop()}return{start:p,stop:d}}function Se(){let r="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let t=0;t<32;t++)r+=e.charAt(Math.floor(Math.random()*e.length));return r}var{showErrorMessage:Ve}=_.window,W=class{constructor(e){this.context=e;this.RProcess=null;this.uiBounds=null;this.sendMessage=null;Re().then(t=>{this.RProcess=t})}static register(e){let t=new W(e);return _.window.registerCustomEditorProvider(W.viewType,t,{webviewOptions:{retainContextWhenHidden:!0}})}async resolveCustomTextEditor(e,t,o){t.webview.options={enableScripts:!0},t.webview.html=this.getHtmlForWebview(t.webview);let n=null,s=async()=>{var m,R;if(!this.RProcess)throw new Error("Failed to sync file state to client, no R process available");console.log("Generating app state");let u=e.getText();if(n!==null&&u.includes(n))return;let h=await Z(u,this.RProcess);if(h==="EMPTY")(m=this.sendMessage)==null||m.call(this,{path:"TEMPLATE-CHOOSER",payload:"please?"});else{let{ui_bounds:E,ui_tree:w}=h;this.uiBounds=E,(R=this.sendMessage)==null||R.call(this,{path:"UPDATED-TREE",payload:w})}},i=V(s,500),c=u=>u.uri.toString()===e.uri.toString(),a=_.workspace.onDidChangeTextDocument(u=>{c(u.document)&&i()}),p=_.workspace.onDidSaveTextDocument(u=>{c(u)&&i.flush()});t.onDidDispose(()=>{a.dispose(),p.dispose(),console.log("Editor window closed",e.fileName)});let d=Pe({pathToApp:e.fileName,onInitiation:()=>{var u;(u=this.sendMessage)==null||u.call(this,{path:"APP-PREVIEW-STATUS",payload:"LOADING"})},onReady:u=>{var f;(f=this.sendMessage)==null||f.call(this,{path:"APP-PREVIEW-STATUS",payload:{url:u}})},onFailToStart:()=>{var u;(u=this.sendMessage)==null||u.call(this,{path:"APP-PREVIEW-CRASH",payload:"Failed to start"})},onCrash:()=>{var u;(u=this.sendMessage)==null||u.call(this,{path:"APP-PREVIEW-CRASH",payload:"Crashed"})},onLogs:u=>{var f;(f=this.sendMessage)==null||f.call(this,{path:"APP-PREVIEW-LOGS",payload:u})}});t.webview.onDidReceiveMessage(async u=>{if(!this.sendMessage)throw new Error("Can't send message back to client, sendMessage not available.");if(Y(u))switch(u.path){case"READY-FOR-STATE":s();return;case"TEMPLATE-SELECTION":{Ve("Have not yet implemented template filling out");return}case"UPDATED-TREE":{if(!this.RProcess||!this.uiBounds)throw new Error("No available R Process or ui bounds, can't update UI tree");let{uiText:f}=await this.updateAppUI(e,u.payload);n=f;return}case"APP-PREVIEW-REQUEST":{d.start();return}case"APP-PREVIEW-STOP":{d.stop();return}case"APP-PREVIEW-RESTART":{d.start();return}default:console.warn("Unhandled message from client",u)}else console.log("Unknown message from webview",u)}),this.sendMessage=u=>t.webview.postMessage(u)}getHtmlForWebview(e){let t=e.asWebviewUri(_.Uri.joinPath(this.context.extensionUri,"media","build","bundle.js")),o=e.asWebviewUri(_.Uri.joinPath(this.context.extensionUri,"media","build","bundle.css")),n=Se(),s=e.cspSource;return`
			<!DOCTYPE html>
			<html lang="en">
			<head>
				<meta charset="UTF-8">
				<script>
				// This is needed for various older packages that require the global
				// object to be defined because it typically was with older bundlers like
				// webpack
				var global = window;
			  <\/script>
				<!--
				Use a content security policy to only allow loading images from https or from our extension directory,
				and only allow scripts that have a specific nonce.
				-->
				<meta 
          http-equiv="Content-Security-Policy" 
          content="default-src 'none'; frame-src http://localhost:*/ ${s} https:; img-src ${s} data:; style-src ${e.cspSource} 'unsafe-inline'; script-src 'nonce-${n}';">

				<meta name="viewport" content="width=device-width, initial-scale=1.0">

				
				<link href="${o}" rel="stylesheet" />
				
				<title>Shiny UI Editor</title>
			</head>
			<body>
				<noscript>You need to enable JavaScript to run this app.</noscript>
				<div id="root" style="height: 100vh; display: relative"></div>
				<script nonce="${n}" src="${t}"><\/script>
			</body>
			</html>`}async updateAppUI(e,t){if(!this.RProcess)throw new Error("Can't access R to build new ui code");if(!this.uiBounds)throw new Error("Attempting to update an app that has yet to be parsed.");let{start:o,end:n}=this.uiBounds,s=await Q(t,this.RProcess),i=new _.Range(o-1,0,n,0),c=new _.WorkspaceEdit,a=`ui <- ${T(...s.text)}
`;c.replace(e.uri,i,a),await _.workspace.applyEdit(c),e.save();let p=n-o+1,u=s.text.length-p;return this.uiBounds={start:o,end:n+u},{uiText:a}}},k=W;k.viewType="shinyUiEditor.appFile";function Qe(r){r.subscriptions.push(k.register(r))}0&&(module.exports={activate});
