"use strict";var ft=Object.create;var W=Object.defineProperty;var mt=Object.getOwnPropertyDescriptor;var gt=Object.getOwnPropertyNames;var ht=Object.getPrototypeOf,vt=Object.prototype.hasOwnProperty;var _t=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),yt=(t,e)=>{for(var o in e)W(t,o,{get:e[o],enumerable:!0})},ie=(t,e,o,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of gt(e))!vt.call(t,n)&&n!==o&&W(t,n,{get:()=>e[n],enumerable:!(r=mt(e,n))||r.enumerable});return t};var S=(t,e,o)=>(o=t!=null?ft(ht(t)):{},ie(e||!t||!t.__esModule?W(o,"default",{value:t,enumerable:!0}):o,t)),Et=t=>ie(W({},"__esModule",{value:!0}),t);var je=_t((wo,He)=>{var ee=require("util"),Ut=require("path"),b=require("child_process").spawn,E=function(){},te="HKLM",Oe="HKCU",Ne="HKCR",be="HKU",Ue="HKCC",Me=[te,Oe,Ne,be,Ue],ke="REG_SZ",De="REG_MULTI_SZ",Ie="REG_EXPAND_SZ",Fe="REG_DWORD",Le="REG_QWORD",Ge="REG_BINARY",$e="REG_NONE",Be=[ke,De,Ie,Fe,Le,Ge,$e],Mt="",kt=/(\\[a-zA-Z0-9_\s]+)*/,Dt=/^(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER|HKEY_CLASSES_ROOT|HKEY_USERS|HKEY_CURRENT_CONFIG)(.*)$/,We=/^(.*)\s(REG_SZ|REG_MULTI_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_NONE)\s+([^\s].*)$/;function L(t,e){if(!(this instanceof L))return new L(t,e);Error.captureStackTrace(this,L),this.__defineGetter__("name",function(){return L.name}),this.__defineGetter__("message",function(){return t}),this.__defineGetter__("code",function(){return e})}ee.inherits(L,Error);function U(t){var e={stdout:"",stderr:""};return t.stdout.on("data",function(o){e.stdout+=o.toString()}),t.stderr.on("data",function(o){e.stderr+=o.toString()}),e}function M(t,e,o){var r=o.stdout.trim(),n=o.stderr.trim(),s=ee.format(`%s command exited with code %d:
%s
%s`,t,e,r,n);return new L(s,e)}function It(t){if(t=="x64")return"64";if(t=="x86")return"32";throw new Error("illegal architecture: "+t+" (use x86 or x64)")}function k(t,e){e&&t.push("/reg:"+It(e))}function D(){return process.platform==="win32"?Ut.join(process.env.windir,"system32","reg.exe"):"REG"}function $(t,e,o,r,n,s,i){if(!(this instanceof $))return new $(t,e,o,r,n,s,i);var a=t,p=e,u=o,d=r,f=n,h=s,c=i;this.__defineGetter__("host",function(){return a}),this.__defineGetter__("hive",function(){return p}),this.__defineGetter__("key",function(){return u}),this.__defineGetter__("name",function(){return d}),this.__defineGetter__("type",function(){return f}),this.__defineGetter__("value",function(){return h}),this.__defineGetter__("arch",function(){return c})}ee.inherits($,Object);function m(t){if(!(this instanceof m))return new m(t);var e=t||{},o=""+(e.host||""),r=""+(e.hive||te),n=""+(e.key||""),s=e.arch||null;if(this.__defineGetter__("host",function(){return o}),this.__defineGetter__("hive",function(){return r}),this.__defineGetter__("key",function(){return n}),this.__defineGetter__("path",function(){return(o.length==0?"":"\\\\"+o+"\\")+r+n}),this.__defineGetter__("arch",function(){return s}),this.__defineGetter__("parent",function(){var i=n.lastIndexOf("\\");return new m({host:this.host,hive:this.hive,key:i==-1?"":n.substring(0,i),arch:this.arch})}),Me.indexOf(r)==-1)throw new Error("illegal hive specified.");if(!kt.test(n))throw new Error("illegal key specified.");if(s&&s!="x64"&&s!="x86")throw new Error("illegal architecture specified (use x86 or x64)")}m.HKLM=te;m.HKCU=Oe;m.HKCR=Ne;m.HKU=be;m.HKCC=Ue;m.HIVES=Me;m.REG_SZ=ke;m.REG_MULTI_SZ=De;m.REG_EXPAND_SZ=Ie;m.REG_DWORD=Fe;m.REG_QWORD=Le;m.REG_BINARY=Ge;m.REG_NONE=$e;m.REG_TYPES=Be;m.DEFAULT_VALUE=Mt;m.prototype.values=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];k(o,this.arch);var r=b(D(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n="",s=this,i=null,a=U(r);return r.on("close",function(p){if(!i)if(p!==0)E("process exited with code "+p),e(M("QUERY",p,a),null);else{for(var u=[],d=[],f=n.split(`
`),h=0,c=0,g=f.length;c<g;c++){var l=f[c].trim();l.length>0&&(E(l),h!=0&&u.push(l),++h)}for(var c=0,g=u.length;c<g;c++){var _=We.exec(u[c]),R,x,v;_&&(R=_[1].trim(),x=_[2].trim(),v=_[3],d.push(new $(s.host,s.hive,s.key,R,x,v,s.arch)))}e(null,d)}}),r.stdout.on("data",function(p){n+=p.toString()}),r.on("error",function(p){i=p,e(p)}),this};m.prototype.keys=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];k(o,this.arch);var r=b(D(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n="",s=this,i=null,a=U(r);return r.on("close",function(p){i||p!==0&&(E("process exited with code "+p),e(M("QUERY",p,a),null))}),r.stdout.on("data",function(p){n+=p.toString()}),r.stdout.on("end",function(){for(var p=[],u=[],d=n.split(`
`),f=0,h=d.length;f<h;f++){var c=d[f].trim();c.length>0&&(E(c),p.push(c))}for(var f=0,h=p.length;f<h;f++){var g=Dt.exec(p[f]),l,_;g&&(l=g[1],_=g[2],_&&_!==s.key&&u.push(new m({host:s.host,hive:s.hive,key:_,arch:s.arch})))}e(null,u)}),r.on("error",function(p){i=p,e(p)}),this};m.prototype.get=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var r=["QUERY",this.path];e==""?r.push("/ve"):r=r.concat(["/v",e]),k(r,this.arch);var n=b(D(),r,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),s="",i=this,a=null,p=U(n);return n.on("close",function(u){if(!a)if(u!==0)E("process exited with code "+u),o(M("QUERY",u,p),null);else{for(var d=[],f=null,h=s.split(`
`),c=0,g=0,l=h.length;g<l;g++){var _=h[g].trim();_.length>0&&(E(_),c!=0&&d.push(_),++c)}var R=d[d.length-1]||"",x=We.exec(R),v,y,C;x&&(v=x[1].trim(),y=x[2].trim(),C=x[3],f=new $(i.host,i.hive,i.key,v,y,C,i.arch)),o(null,f)}}),n.stdout.on("data",function(u){s+=u.toString()}),n.on("error",function(u){a=u,o(u)}),this};m.prototype.set=function(e,o,r,n){if(typeof n!="function")throw new TypeError("must specify a callback");if(Be.indexOf(o)==-1)throw Error("illegal type specified.");var s=["ADD",this.path];e==""?s.push("/ve"):s=s.concat(["/v",e]),s=s.concat(["/t",o,"/d",r,"/f"]),k(s,this.arch);var i=b(D(),s,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),a=null,p=U(i);return i.on("close",function(u){a||(u!==0?(E("process exited with code "+u),n(M("ADD",u,p,null))):n(null))}),i.stdout.on("data",function(u){E(""+u)}),i.on("error",function(u){a=u,n(u)}),this};m.prototype.remove=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var r=e?["DELETE",this.path,"/f","/v",e]:["DELETE",this.path,"/f","/ve"];k(r,this.arch);var n=b(D(),r,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),s=null,i=U(n);return n.on("close",function(a){s||(a!==0?(E("process exited with code "+a),o(M("DELETE",a,i),null)):o(null))}),n.stdout.on("data",function(a){E(""+a)}),n.on("error",function(a){s=a,o(a)}),this};m.prototype.clear=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f","/va"];k(o,this.arch);var r=b(D(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,s=U(r);return r.on("close",function(i){n||(i!==0?(E("process exited with code "+i),e(M("DELETE",i,s),null)):e(null))}),r.stdout.on("data",function(i){E(""+i)}),r.on("error",function(i){n=i,e(i)}),this};m.prototype.erase=m.prototype.clear;m.prototype.destroy=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f"];k(o,this.arch);var r=b(D(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,s=U(r);return r.on("close",function(i){n||(i!==0?(E("process exited with code "+i),e(M("DELETE",i,s),null)):e(null))}),r.stdout.on("data",function(i){E(""+i)}),r.on("error",function(i){n=i,e(i)}),this};m.prototype.create=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["ADD",this.path,"/f"];k(o,this.arch);var r=b(D(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,s=U(r);return r.on("close",function(i){n||(i!==0?(E("process exited with code "+i),e(M("ADD",i,s),null)):e(null))}),r.stdout.on("data",function(i){E(""+i)}),r.on("error",function(i){n=i,e(i)}),this};m.prototype.keyExists=function(e){return this.values(function(o,r){if(o)return o.code==1?e(null,!1):e(o);e(null,!0)}),this};m.prototype.valueExists=function(e,o){return this.get(e,function(r,n){if(r)return r.code==1?o(null,!1):o(r);o(null,!0)}),this};He.exports=m});var Vt={};yt(Vt,{activate:()=>jt});module.exports=Et(Vt);var se=S(require("vscode"));var O=require("vscode"),T=S(require("vscode"));var J="app.R",Rt=/^([\w|\s]+)([\.[\w|^\.]*]*)$/i;function X(t){if(t==="")return{valid:!0,name:J};let e=t.match(Rt);if(e===null)return{valid:!1,msg:`Invalid app name: ${t}.`};let[o,r,n]=e;return(n===""||n===".")&&(n=".R"),r?n!==".R"?{valid:!1,msg:`Invalid file extension: ${n}. Extension needs to be .R`}:(r=r.replaceAll(" ","-"),{valid:!0,name:`${r}${n}`}):{valid:!1,msg:`Invalid app name: ${t}. Make sure to only use numbers and letters. Spaces will be converted to dashes.`}}var ae=new TextEncoder().encode("");async function ue(){let t=await O.window.showOpenDialog({canSelectFolders:!0,canSelectFiles:!0,title:"Choose location for Shiny app",openLabel:"Choose app folder or file",canSelectMany:!1,filters:{"R scripts":["R","r"]}});if(!t)return;let e=t[0],r=(await T.workspace.fs.stat(e)).type===T.FileType.Directory?await St(e):e;!r||T.commands.executeCommand("vscode.openWith",r,"shinyuieditor.appFile")}async function St(t){let e=(await O.workspace.fs.readDirectory(t)).filter(([i,a])=>a===T.FileType.File).map(([i,a])=>i),o=await O.window.showInputBox({prompt:"Enter file name for new app",placeHolder:J,validateInput(i){let a=X(i);return a.valid?e.includes(a.name)?{message:`Run the editor on existing app: ${a.name}.`,severity:T.InputBoxValidationSeverity.Info}:{message:`Run the template chooser to build new app: ${a.name}.`,severity:T.InputBoxValidationSeverity.Info}:{message:a.msg,severity:T.InputBoxValidationSeverity.Error}}});if(!o)return;let r=X(o);if(!r.valid){T.window.showErrorMessage(`Error processing requested file name: ${o}. Try with a different name.`);return}let n=O.Uri.joinPath(t,r.name);return e.includes(r.name)||await O.workspace.fs.writeFile(n,ae),n}var pe=S(require("path")),ce=S(require("vscode")),H=require("vscode");function wt(t){let e=t.ext;return/\.R/i.test(e)}function de(t="world"){let e=H.window.activeTextEditor;if(!e){H.window.showErrorMessage("No active file open to run ui editor on!");return}let o=pe.default.parse(e.document.fileName);if(!wt(o)){H.window.showErrorMessage(`Can't run the ui editor on the currently active file ${o.base}, needs to be a .R file.`);return}ce.commands.executeCommand("vscode.openWith",e.document.uri,"shinyuieditor.appFile")}var P=S(require("vscode"));function Tt(t){return typeof t=="object"&&t!==null}function le(t){return Tt(t)?"path"in t:!1}var fe=xt;function xt(t,e,o){var r=null,n=null,s=function(){r&&(clearTimeout(r),n=null,r=null)},i=function(){var p=n;s(),p&&p()},a=function(){if(!e)return t.apply(this,arguments);var p=this,u=arguments,d=o&&!r;if(s(),n=function(){t.apply(p,u)},r=setTimeout(function(){if(r=null,!d){var f=n;return n=null,f()}},e),d)return n()};return a.cancel=s,a.flush=i,a}var nt=S(require("vscode"));var I=S(require("vscode"));var me=S(require("vscode"));function j({start:t,end:e}){return new me.Selection(t-1,0,e,0)}async function V({text:t,document:e,uiBounds:o={start:0,end:0},type:r}){let n=e.uri,s=new I.WorkspaceEdit;if(r==="replace"){let i=j(o);s.replace(n,i,t)}r==="insert"&&s.insert(e.uri,new I.Position(0,0),t),await I.workspace.applyEdit(s),e.save()}var F=S(require("vscode"));async function ge(t){let e=t.uri,o=new F.WorkspaceEdit,r=t.validateRange(new F.Range(0,0,1/0,1/0));o.replace(e,r,""),await F.workspace.applyEdit(o),t.save()}var G=S(require("vscode"));async function z({appFile:t,existingEditor:e}){return e&&G.window.visibleTextEditors.includes(e)?e:await G.window.showTextDocument(t.uri,{viewColumn:G.ViewColumn.Beside,preview:!0})}function he(t,e){e.selection=j(t)}async function ve(t,e){let o=await t.runCmd(`print(require(${e}, quietly = TRUE))`,{verbose:!1});return o.status==="error"?{status:"error",msg:o.errorMsg}:o.values[0].includes("FALSE")?{status:"error",msg:At(e)}:{status:"success"}}function At(t){return`The ShinyUiEditor extension needs the \`${t}\` pkg installed. Install using \`remotes::install_github('rstudio/${t}')\` and restart the extension.`}function w(...t){return t.filter(o=>o!==void 0).reduce((o,r,n)=>(n===0?"":o+`
`)+r,"")}function N(t){return t.replace(/"/g,'\\"')}function _e(t){return t.replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}async function ye(t,e,o){let r=await t.runCmd(`styler::style_text("${N(e)}", scope = "tokens")`,o);if(r.status==="error")throw new Error(`Failed to format new app code...
`+r.errorMsg);return r.values.reduce((n,s)=>n+`
`+s,"")}async function K(t,e){let o=Pt(t);try{let r=await e.runCmd(o,{verbose:!1});if(r.status==="error")throw new Error(`Failed to generate new ui code from tree
${r.errorMsg}`);return JSON.parse(w(...r.values))}catch(r){throw r}}function Pt(t,e=!0){let o=N(JSON.stringify(t,null,2)),r=e?"TRUE":"FALSE";return w("ui_tree <- jsonlite::fromJSON(",`  txt = "${o}",`,"  simplifyVector = FALSE",")",`new_ui_code <- shinyuieditor:::ui_tree_to_code(ui_tree, remove_namespace = ${r})`,"new_ui_code$text <- as.character(new_ui_code$text)","jsonlite::toJSON(new_ui_code, auto_unbox = TRUE)")}async function Ee(t,{uiTree:e,otherCode:{uiExtra:o,serverFunctionBody:r,serverExtra:n,serverLibraries:s}}){let{text:i,namespaces_removed:a}=await K(e,t),u=[...new Set([...s!=null?s:[],...a])].map(g=>`library(${g})`),d=["server <- function(input, output) {",r,"}"],f="ui <- "+w(...i),h=w(...u,o,"",f,"",n,"",...d,"","shinyApp(ui, server)");return await ye(t,h)}async function Re(t,e){let o=Ct(e),r=await t.runCmd(o,{verbose:!1,timeout_ms:5e3});if(r.status==="error")return r;try{let n=JSON.parse(r.values.reduce((s,i)=>s+`
`+i,""));return Object.keys(n).length===0?{status:"success",values:"EMPTY"}:{status:"success",values:n}}catch{return{status:"error",errorMsg:"Could not get document as json. Content is not valid json"}}}function Ct(t){let e=N(t);return w(`app_lines <- strsplit("${e}", "\\n")[[1]]`,"jsonlite::toJSON(",'  shinyuieditor:::get_file_ui_definition_info(app_lines, "SINGLE-FILE"),',"  auto_unbox = TRUE",")")}var Te=S(require("fs")),Y=S(require("vscode"));var Se=require("child_process");async function we({cmd:t,args:e,verbose:o=!1,timeout_ms:r=1500}){let n=Ot(o,"runShellCommand: ");return new Promise(s=>{let i={stdout:[],stderr:[]},a=(0,Se.spawn)(t,e);function p(){n("Spawned")}function u(l){n("Error "+l.message),c(),s({status:"error",errorMsgs:l.message,...i})}function d(){n("Close"),c(),s({status:"success",...i})}function f(l){n(`stdout: ${l.toString()}`),i.stdout.push(l.toString())}function h(l){n(`stderr: ${l.toString()}`),i.stderr.push(l.toString())}function c(){clearTimeout(g),a.off("spawn",p),a.off("error",u),a.off("close",d),a.stdout.off("data",f),a.stderr.off("data",h)}let g=setTimeout(()=>{s({status:"error",errorMsgs:`Command, no response from run command within ${r}ms:
${t} ${e==null?void 0:e.join(" ")}`,...i}),c()},r);a.on("spawn",p),a.on("error",u),a.on("close",d),a.stdout.on("data",f),a.stderr.on("data",h)})}function Ot(t,e){return o=>{t&&console.log(e+o)}}async function xe(t){if(Nt())return await bt(t);let e=Y.Uri.parse(`http://localhost:${t}`);return(await Y.env.asExternalUri(e)).toString()}var Ae="/usr/lib/rstudio-server/bin/rserver-url";function Nt(){return"RS_SERVER_URL"in process.env?Te.existsSync(Ae):!1}async function bt(t){let e=await we({cmd:Ae,args:[String(t)]});e.status==="error"&&Error(`Failed to get Posit workbench forwarded port. Error msg:
`+e.errorMsgs);let o=process.env.RS_SERVER_URL,r=process.env.RS_SESSION_URL;if(!o||!r)throw new Error("Can't find URL for workbench.");let n=e.stdout[0];return`${o}${r.slice(1)}p/${n}/`}var Pe=S(require("net"));async function Ce(){return new Promise(t=>{let e=Pe.default.createServer();e.listen(0,()=>{var r;let o=(r=e.address)==null?void 0:r.call(e);if(typeof o=="string"||o===null)throw new Error("Failed to find a free port...");e.close(n=>t(o.port))})})}var Ze=require("child_process");var Qe=require("fs");var Ke=require("fs"),oe=S(require("path")),Ve=je();async function Ye(){let t=process.platform,e=Ft(t);if(!e&&t==="win32")try{let o=new Ve({hive:Ve.HKLM,key:"\\Software\\R-Core\\R"}),r=await new Promise((n,s)=>o.get("InstallPath",(i,a)=>i===null?n(a):s(i)));e=oe.default.join(r.value,"bin","R.exe")}catch{e=""}return e}function Ft(t){let e=":",o="";t==="win32"&&(e=";",o=".exe");let r=process.env.PATH?process.env.PATH.split(e):[];for(let n of r){let s=oe.default.join(n,"R"+o);if((0,Ke.existsSync)(s))return s}return""}async function qe(){let t=await Ye();if(!t){let e="Cannot find R for running shinyuieditor. Make sure R is installed and/or updating the shinyuieditor extension settings option to proper to R path.";throw new Error(e)}if(!(0,Qe.existsSync)(t)){let e=`Path to R is invalid: ${t}. Make sure R is installed and/or updating the shinyuieditor extension settings option to proper to R path.`;throw new Error(e)}return _e(t)}async function Q(t,e={}){let o=await qe();if(o===void 0)throw new Error("Can't get R path");let r="";return new Promise(n=>{var x;let s=new AbortController,{signal:i}=s,a=(0,Ze.spawn)(o,t,{signal:i});a.on("spawn",d),a.on("error",f),a.on("close",h),a.stdout.on("data",c),a.stderr.on("data",g);function p(v,y){r+=`${v}: ${y}`}function u(v){!e.verbose||console.log(`%c[RProc ${a.pid}] %c${v.replaceAll(/\n$/g,"").replaceAll(/\n/g,`
\u2219\u2219\u2219 `)}`,"color: orangered;","color: grey; opacity: 0.5")}function d(){u("spawned"),clearTimeout(R),n({proc:a,stop:_,getIsRunning:()=>a.exitCode===null})}function f(v){var y;u(`Error: 
${v.toString()}`),clearTimeout(R),(y=e.onError)==null||y.call(e,v)}function h(){var v;u("Closed"),clearTimeout(R),(v=e.onClose)==null||v.call(e)}function c(v){var C;let y=v.toString();u(`stdout: 
${y}`),p("out",y),(C=e.onStdout)==null||C.call(e,y)}function g(v){var C;let y=v.toString();u(`stderr: ${y}`),p("error",y),(C=e.onStderr)==null||C.call(e,y)}function l(){a.off("spawn",d),a.off("error",f),a.off("close",h),a.stdout.off("data",c),a.stderr.off("data",g)}function _(){return l(),!a.pid||!a.connected?!0:(u(`Killing R process ${a.pid}`),process.kill(a.pid))}let R=setTimeout(()=>{throw _(),new Error(`Starting backend server failed.
 Logs:
`+r)},(x=e.timeout_ms)!=null?x:5e3)})}function Je({pathToApp:t,onCrash:e,onInitiation:o,onReady:r,onFailToStart:n,onLogs:s}){let i="0.0.0.0",a=null;async function p(){o(),u();try{let d=await Ce(),f=await xe(d),h=new RegExp(`listening on .+${d}`,"i"),c=w("options(shiny.autoreload = TRUE)",`shiny::runApp(appDir = "${t}", port = ${d}, host = "${i}")`);return a=await Q(["--no-save","--no-restore","--silent","-e",c],{onStderr(g){h.test(g)&&r(f.toString()),s(g.split(`
`))},onClose:e,onError:e}),!0}catch{return n(),!1}}function u(){return a===null?!0:a.stop()}return{start:p,stop:u}}function re(t){return typeof t=="object"&&t!==null}function Xe(t){return re(t)&&"val"in t&&["string","boolean","number"].includes(typeof t.val)}function q(t){return re(t)&&"val"in t&&Array.isArray(t.val)}function Lt(t,e){if(!q(t))return!1;let{val:o}=t;return o[0].val==="<-"||o[0].val==="="?e?o[1].val===e:!0:!1}function Gt(t){return t.val[1]}function ne(t){let e=[];return t.forEach(o=>{if(Lt(o)){let r=Gt(o);Xe(r)?e.push({name:String(r.val),is_output:!1,node:o}):$t(r)&&e.push({name:r.val[2].val,is_output:!0,node:o})}if(q(o)){let r=ne(o.val);e.push(...r)}}),e}function $t(t){if(!q(t))return!1;let{val:e}=t;return e.length===3&&e[1].val==="output"&&typeof e[2].val=="string"}function ze(t){return t.filter(({is_output:e})=>e).reduce((e,{name:o,node:r})=>{var s;let{pos:n}=r;return n&&(e[o]=[...(s=e[o])!=null?s:[],n]),e},{})}var A=S(require("vscode"));async function et(t,e){let o=N(e),r=w(`app_lines <- strsplit("${o}", "\\n")[[1]]`,"parsed <- parse(text = app_lines, keep.source = TRUE)","jsonlite::toJSON(","  shinyuieditor:::serialize_ast(parsed),","  auto_unbox = TRUE",")"),n=await t.runCmd(r,{verbose:!1,timeout_ms:5e3});if(n.status==="error")return n;try{let s=JSON.parse(n.values.reduce((i,a)=>i+`
`+a,""));return Object.keys(s).length===0?{status:"success",values:"EMPTY"}:{status:"success",values:s}}catch{return{status:"error",errorMsg:"Could not get document as json. Content is not valid json"}}}async function tt({editor:t,output:{outputId:e},RProcess:o}){let r=t.document.getText(),n=await et(o,r),s=n.status==="success"&&n.values!=="EMPTY"?Bt(n.values,e):Wt(r,e);if(!s){A.window.showErrorMessage(`Failed to find any current use of output$${e} in server`);return}t.selection=s[0],t.revealRange(s[0])}function Bt(t,e){let o=ne(t),n=ze(o)[e];return n?n.map(([s,i,a,p])=>{let u=new A.Position(s-1,i-1),d=new A.Position(a-1,p);return new A.Selection(u,d)}):null}function Wt(t,e){let o=t.split(`
`),r=new RegExp(`output\\$${e}`,"g"),n=o.map((s,i)=>({line:i,match:r.exec(s)})).filter(({match:s})=>s!==null);return n.length===0?null:n.map(({line:s,match:i})=>{var d;let a=(d=i==null?void 0:i.index)!=null?d:0,p=new A.Position(s,a),u=new A.Position(s,a+e.length+7);return new A.Selection(p,u)})}async function ot({document:t,uiBounds:e,RProcess:o,uiTree:r}){if(!e)throw new Error("Attempting to update an app that has yet to be parsed.");let{start:n,end:s}=e,i=await K(r,o),a=`ui <- ${w(...i.text)}
`;await V({text:a,document:t,uiBounds:e,type:"replace"});let p=s-n+1,d=i.text.length-p;return{uiText:a,uiBounds:{start:n,end:s+d}}}var{showErrorMessage:rt}=nt.window;function st({RProcess:t,document:e,sendMessage:o}){let r=!1,n=null,s,i,a=async()=>{let c=e.getText();if(!(n!==null&&c.includes(n))){if(!r){let l=await ve(t,"shinyuieditor");if(l.status==="error")throw o({path:"BACKEND-ERROR",payload:{context:"checking for shinyuieditor package",msg:l.msg}}),rt(l.msg),new Error(l.msg);r=!0}try{let l=await Re(t,c);if(l.status==="error"){o({path:"BACKEND-ERROR",payload:{context:"parsing app",msg:l.errorMsg}}),rt(l.errorMsg);return}if(l.values==="EMPTY")o({path:"TEMPLATE_CHOOSER",payload:"SINGLE-FILE"});else{let{ui_tree:_}=l.values;s=l.values.ui_bounds,o({path:"UPDATED-TREE",payload:_})}}catch(l){console.error("Failed to parse",l)}}},p=fe(a,500),u=()=>{p()},d=()=>{p.flush()},f=Je({pathToApp:e.fileName,onInitiation:()=>{o({path:"APP-PREVIEW-STATUS",payload:"LOADING"})},onReady:c=>{o({path:"APP-PREVIEW-STATUS",payload:{url:c}})},onFailToStart:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Failed to start"})},onCrash:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Crashed"})},onLogs:c=>{o({path:"APP-PREVIEW-LOGS",payload:c})}});return{onDocumentChanged:u,onDocumentSaved:d,onDidReceiveMessage:async c=>{if(le(c))switch(c.path){case"READY-FOR-STATE":a();return;case"TEMPLATE-SELECTION":{let g=await Ee(t,c.payload);await V({text:g,document:e,type:"insert",uiBounds:s});return}case"UPDATED-TREE":{let g=await ot({document:e,uiBounds:s,RProcess:t,uiTree:c.payload});n=g.uiText,s=g.uiBounds;return}case"APP-PREVIEW-REQUEST":{f.start();return}case"APP-PREVIEW-STOP":{f.stop();return}case"APP-PREVIEW-RESTART":{f.start();return}case"ENTERED-TEMPLATE-SELECTOR":{f.stop(),await ge(e);return}case"OPEN-COMPANION-EDITOR":{i=await z({appFile:e,existingEditor:i}),s&&he(s,i);return}case"GO-TO-SERVER":{i=await z({appFile:e,existingEditor:i}),tt({editor:i,output:c.payload,RProcess:t});return}case"NODE-SELECTION":{console.log("New node selection",c.payload);return}default:console.warn("Unhandled message from client",c)}else console.log("Unknown message from webview",c)}}}function it(t){let e=t.getText();return e.trim()===""?"empty":Ht.test(e)?"valid":"invalid"}var Ht=/shinyApp\(/;var at="SUE_START_SIGNAL",ut="SUE_END_SIGNAL";async function pt(t,e,{timeout_ms:o=1e3,verbose:r=!1}={}){let n=p=>{r&&console.log(`runRCommand: ${p}`)},s="",i=!1,a=[];return t.exitCode!==null?{status:"error",errorMsg:`Can't run R command as background R process has exited with code ${t.exitCode}.`}:new Promise(p=>{function u(g){let _=g.toString().split(`
`);n("~~~Output chunk~~~");for(let R of _){let x=R.includes(at),v=R.includes(ut),y=R.length===0;if(x){i=!0;continue}if(v){clearTimeout(h),p({status:"success",values:a}),n("Output finished"),c();break}!i||y||(n(R),s+=R+`
`,a.push(R))}}function d(g){let l=g.toString();s+=`stderr: ${l}
`,n("stderr: "+l)}function f(){p({status:"error",errorMsg:s}),c()}t.stdout.on("data",u),t.stderr.on("data",d),t.on("close",f);let h=setTimeout(()=>{p({status:"error",errorMsg:`Timeout, no response from run command within ${o}ms: ${e}
 Logs:
 ${s}`}),c()},o);function c(){t.stdout.off("data",u),t.stderr.off("data",d),t.off("close",f)}ct(`print('${at}');${e};print('${ut}')`,t)})}async function dt(){async function t(){return await Q(["--silent","--slave","--no-save","--no-restore"],{timeout_ms:5e3})}let e=await t();return{...e,async runCmd(o,r){return e.getIsRunning()||(console.warn("Background R Process has crashed. Restarting..."),e.stop(),e=await t(),console.warn("Background R Process restarted")),pt(e.proc,o,r)}}}function ct(t,e){e.stdin.write(`${t}
`)}function lt(){let t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<32;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}var Z=class{constructor(e){this.context=e;this.RProcess=null;dt().then(o=>{this.RProcess=o})}static register(e){let o=new Z(e);return P.window.registerCustomEditorProvider(Z.viewType,o,{webviewOptions:{retainContextWhenHidden:!0}})}async resolveCustomTextEditor(e,o,r){if(it(e)==="invalid"){let u="The active file doesn't appear to be a Shiny app. Make sure that the script is either empty or has a valid shiny app in it.";throw P.window.showErrorMessage(u),o.dispose(),new Error(u)}if(o.webview.options={enableScripts:!0},o.webview.html=this.getHtmlForWebview(o.webview),!this.RProcess)throw new Error("Don't have an R Process to pass to editor backend!");let s=st({RProcess:this.RProcess,document:e,sendMessage:u=>o.webview.postMessage(u)}),i=P.workspace.onDidChangeTextDocument(u=>{u.document.uri.toString()===e.uri.toString()&&s.onDocumentChanged()}),a=P.workspace.onDidSaveTextDocument(u=>{u.uri.toString()===e.uri.toString()&&s.onDocumentSaved()}),p=o.webview.onDidReceiveMessage(s.onDidReceiveMessage);o.onDidDispose(()=>{i.dispose(),a.dispose(),p.dispose()})}getHtmlForWebview(e){let o=e.asWebviewUri(P.Uri.joinPath(this.context.extensionUri,"media","build","bundle.js")),r=e.asWebviewUri(P.Uri.joinPath(this.context.extensionUri,"media","build","bundle.css")),n=lt(),s=e.cspSource;return`
			<!DOCTYPE html>
			<html lang="en">
			<head>
				<meta charset="UTF-8">
				<script>
				// This is needed for various older packages that require the global
				// object to be defined because it typically was with older bundlers like
				// webpack
				var global = window;
			  <\/script>
				<!--
				Use a content security policy to only allow loading images from https or from our extension directory,
				and only allow scripts that have a specific nonce.
				-->
				<meta 
          http-equiv="Content-Security-Policy" 
          content="default-src 'none'; frame-src http://localhost:*/ ${s} https:; img-src ${s} data:; style-src ${e.cspSource} 'unsafe-inline'; script-src 'nonce-${n}';">

				<meta name="viewport" content="width=device-width, initial-scale=1.0">

				
				<link href="${r}" rel="stylesheet" />
				
				<title>Shiny UI Editor</title>
			</head>
			<body style="padding-inline: 0;">
				<noscript>You need to enable JavaScript to run this app.</noscript>
				<div id="root" style="height: 100vh; display: relative"></div>
				<script nonce="${n}" src="${o}"><\/script>
			</body>
			</html>`}},B=Z;B.viewType="shinyuieditor.appFile";function jt(t){t.subscriptions.push(B.register(t)),t.subscriptions.push(se.commands.registerCommand("shinyuieditor.startEditorOnActiveFile",de),se.commands.registerCommand("shinyuieditor.launchEditor",ue))}0&&(module.exports={activate});
