"use strict";var st=Object.create;var $=Object.defineProperty;var it=Object.getOwnPropertyDescriptor;var at=Object.getOwnPropertyNames;var ct=Object.getPrototypeOf,pt=Object.prototype.hasOwnProperty;var ut=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),lt=(t,e)=>{for(var o in e)$(t,o,{get:e[o],enumerable:!0})},J=(t,e,o,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of at(e))!pt.call(t,n)&&n!==o&&$(t,n,{get:()=>e[n],enumerable:!(r=it(e,n))||r.enumerable});return t};var S=(t,e,o)=>(o=t!=null?st(ct(t)):{},J(e||!t||!t.__esModule?$(o,"default",{value:t,enumerable:!0}):o,t)),dt=t=>J($({},"__esModule",{value:!0}),t);var Ue=ut((Zt,Me)=>{var j=require("util"),Rt=require("path"),A=require("child_process").spawn,R=function(){},Q="HKLM",Re="HKCU",we="HKCR",Se="HKU",xe="HKCC",Te=[Q,Re,we,Se,xe],Pe="REG_SZ",Ae="REG_MULTI_SZ",Ce="REG_EXPAND_SZ",Ie="REG_DWORD",Oe="REG_QWORD",ke="REG_BINARY",De="REG_NONE",be=[Pe,Ae,Ce,Ie,Oe,ke,De],wt="",St=/(\\[a-zA-Z0-9_\s]+)*/,xt=/^(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER|HKEY_CLASSES_ROOT|HKEY_USERS|HKEY_CURRENT_CONFIG)(.*)$/,Ne=/^(.*)\s(REG_SZ|REG_MULTI_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_NONE)\s+([^\s].*)$/;function b(t,e){if(!(this instanceof b))return new b(t,e);Error.captureStackTrace(this,b),this.__defineGetter__("name",function(){return b.name}),this.__defineGetter__("message",function(){return t}),this.__defineGetter__("code",function(){return e})}j.inherits(b,Error);function C(t){var e={stdout:"",stderr:""};return t.stdout.on("data",function(o){e.stdout+=o.toString()}),t.stderr.on("data",function(o){e.stderr+=o.toString()}),e}function I(t,e,o){var r=o.stdout.trim(),n=o.stderr.trim(),a=j.format(`%s command exited with code %d:
%s
%s`,t,e,r,n);return new b(a,e)}function Tt(t){if(t=="x64")return"64";if(t=="x86")return"32";throw new Error("illegal architecture: "+t+" (use x86 or x64)")}function O(t,e){e&&t.push("/reg:"+Tt(e))}function k(){return process.platform==="win32"?Rt.join(process.env.windir,"system32","reg.exe"):"REG"}function U(t,e,o,r,n,a,s){if(!(this instanceof U))return new U(t,e,o,r,n,a,s);var i=t,p=e,c=o,l=r,d=n,g=a,u=s;this.__defineGetter__("host",function(){return i}),this.__defineGetter__("hive",function(){return p}),this.__defineGetter__("key",function(){return c}),this.__defineGetter__("name",function(){return l}),this.__defineGetter__("type",function(){return d}),this.__defineGetter__("value",function(){return g}),this.__defineGetter__("arch",function(){return u})}j.inherits(U,Object);function m(t){if(!(this instanceof m))return new m(t);var e=t||{},o=""+(e.host||""),r=""+(e.hive||Q),n=""+(e.key||""),a=e.arch||null;if(this.__defineGetter__("host",function(){return o}),this.__defineGetter__("hive",function(){return r}),this.__defineGetter__("key",function(){return n}),this.__defineGetter__("path",function(){return(o.length==0?"":"\\\\"+o+"\\")+r+n}),this.__defineGetter__("arch",function(){return a}),this.__defineGetter__("parent",function(){var s=n.lastIndexOf("\\");return new m({host:this.host,hive:this.hive,key:s==-1?"":n.substring(0,s),arch:this.arch})}),Te.indexOf(r)==-1)throw new Error("illegal hive specified.");if(!St.test(n))throw new Error("illegal key specified.");if(a&&a!="x64"&&a!="x86")throw new Error("illegal architecture specified (use x86 or x64)")}m.HKLM=Q;m.HKCU=Re;m.HKCR=we;m.HKU=Se;m.HKCC=xe;m.HIVES=Te;m.REG_SZ=Pe;m.REG_MULTI_SZ=Ae;m.REG_EXPAND_SZ=Ce;m.REG_DWORD=Ie;m.REG_QWORD=Oe;m.REG_BINARY=ke;m.REG_NONE=De;m.REG_TYPES=be;m.DEFAULT_VALUE=wt;m.prototype.values=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];O(o,this.arch);var r=A(k(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n="",a=this,s=null,i=C(r);return r.on("close",function(p){if(!s)if(p!==0)R("process exited with code "+p),e(I("QUERY",p,i),null);else{for(var c=[],l=[],d=n.split(`
`),g=0,u=0,h=d.length;u<h;u++){var f=d[u].trim();f.length>0&&(R(f),g!=0&&c.push(f),++g)}for(var u=0,h=c.length;u<h;u++){var E=Ne.exec(c[u]),w,v,y;E&&(w=E[1].trim(),v=E[2].trim(),y=E[3],l.push(new U(a.host,a.hive,a.key,w,v,y,a.arch)))}e(null,l)}}),r.stdout.on("data",function(p){n+=p.toString()}),r.on("error",function(p){s=p,e(p)}),this};m.prototype.keys=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];O(o,this.arch);var r=A(k(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n="",a=this,s=null,i=C(r);return r.on("close",function(p){s||p!==0&&(R("process exited with code "+p),e(I("QUERY",p,i),null))}),r.stdout.on("data",function(p){n+=p.toString()}),r.stdout.on("end",function(){for(var p=[],c=[],l=n.split(`
`),d=0,g=l.length;d<g;d++){var u=l[d].trim();u.length>0&&(R(u),p.push(u))}for(var d=0,g=p.length;d<g;d++){var h=xt.exec(p[d]),f,E;h&&(f=h[1],E=h[2],E&&E!==a.key&&c.push(new m({host:a.host,hive:a.hive,key:E,arch:a.arch})))}e(null,c)}),r.on("error",function(p){s=p,e(p)}),this};m.prototype.get=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var r=["QUERY",this.path];e==""?r.push("/ve"):r=r.concat(["/v",e]),O(r,this.arch);var n=A(k(),r,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),a="",s=this,i=null,p=C(n);return n.on("close",function(c){if(!i)if(c!==0)R("process exited with code "+c),o(I("QUERY",c,p),null);else{for(var l=[],d=null,g=a.split(`
`),u=0,h=0,f=g.length;h<f;h++){var E=g[h].trim();E.length>0&&(R(E),u!=0&&l.push(E),++u)}var w=l[l.length-1]||"",v=Ne.exec(w),y,F,z;v&&(y=v[1].trim(),F=v[2].trim(),z=v[3],d=new U(s.host,s.hive,s.key,y,F,z,s.arch)),o(null,d)}}),n.stdout.on("data",function(c){a+=c.toString()}),n.on("error",function(c){i=c,o(c)}),this};m.prototype.set=function(e,o,r,n){if(typeof n!="function")throw new TypeError("must specify a callback");if(be.indexOf(o)==-1)throw Error("illegal type specified.");var a=["ADD",this.path];e==""?a.push("/ve"):a=a.concat(["/v",e]),a=a.concat(["/t",o,"/d",r,"/f"]),O(a,this.arch);var s=A(k(),a,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),i=null,p=C(s);return s.on("close",function(c){i||(c!==0?(R("process exited with code "+c),n(I("ADD",c,p,null))):n(null))}),s.stdout.on("data",function(c){R(""+c)}),s.on("error",function(c){i=c,n(c)}),this};m.prototype.remove=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var r=e?["DELETE",this.path,"/f","/v",e]:["DELETE",this.path,"/f","/ve"];O(r,this.arch);var n=A(k(),r,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),a=null,s=C(n);return n.on("close",function(i){a||(i!==0?(R("process exited with code "+i),o(I("DELETE",i,s),null)):o(null))}),n.stdout.on("data",function(i){R(""+i)}),n.on("error",function(i){a=i,o(i)}),this};m.prototype.clear=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f","/va"];O(o,this.arch);var r=A(k(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,a=C(r);return r.on("close",function(s){n||(s!==0?(R("process exited with code "+s),e(I("DELETE",s,a),null)):e(null))}),r.stdout.on("data",function(s){R(""+s)}),r.on("error",function(s){n=s,e(s)}),this};m.prototype.erase=m.prototype.clear;m.prototype.destroy=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f"];O(o,this.arch);var r=A(k(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,a=C(r);return r.on("close",function(s){n||(s!==0?(R("process exited with code "+s),e(I("DELETE",s,a),null)):e(null))}),r.stdout.on("data",function(s){R(""+s)}),r.on("error",function(s){n=s,e(s)}),this};m.prototype.create=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["ADD",this.path,"/f"];O(o,this.arch);var r=A(k(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),n=null,a=C(r);return r.on("close",function(s){n||(s!==0?(R("process exited with code "+s),e(I("ADD",s,a),null)):e(null))}),r.stdout.on("data",function(s){R(""+s)}),r.on("error",function(s){n=s,e(s)}),this};m.prototype.keyExists=function(e){return this.values(function(o,r){if(o)return o.code==1?e(null,!1):e(o);e(null,!0)}),this};m.prototype.valueExists=function(e,o){return this.get(e,function(r,n){if(r)return r.code==1?o(null,!1):o(r);o(null,!0)}),this};Me.exports=m});var Ot={};lt(Ot,{activate:()=>It});module.exports=dt(Ot);var X=S(require("vscode"));var P=require("vscode"),x=S(require("vscode"));var V="app.R",ft=/^([\w|\s]+)([\.[\w|^\.]*]*)$/i;function q(t){if(t==="")return{valid:!0,name:V};let e=t.match(ft);if(e===null)return{valid:!1,msg:`Invalid app name: ${t}.`};let[o,r,n]=e;return(n===""||n===".")&&(n=".R"),r?n!==".R"?{valid:!1,msg:`Invalid file extension: ${n}. Extension needs to be .R`}:(r=r.replaceAll(" ","-"),{valid:!0,name:`${r}${n}`}):{valid:!1,msg:`Invalid app name: ${t}. Make sure to only use numbers and letters. Spaces will be converted to dashes.`}}var ee=new TextEncoder().encode("");async function te(){let t=await P.window.showOpenDialog({canSelectFolders:!0,canSelectFiles:!0,title:"Choose location for Shiny app",openLabel:"Choose app folder or file",canSelectMany:!1,filters:{"R scripts":["R","r"]}});if(!t)return;let e=t[0],r=(await x.workspace.fs.stat(e)).type===x.FileType.Directory?await mt(e):e;r&&x.commands.executeCommand("vscode.openWith",r,"shinyuieditor.appFile")}async function mt(t){let e=(await P.workspace.fs.readDirectory(t)).filter(([s,i])=>i===x.FileType.File).map(([s,i])=>s),o=await P.window.showInputBox({prompt:"Enter file name for new app",placeHolder:V,validateInput(s){let i=q(s);return i.valid?e.includes(i.name)?{message:`Run the editor on existing app: ${i.name}.`,severity:x.InputBoxValidationSeverity.Info}:{message:`Run the template chooser to build new app: ${i.name}.`,severity:x.InputBoxValidationSeverity.Info}:{message:i.msg,severity:x.InputBoxValidationSeverity.Error}}});if(!o)return;let r=q(o);if(!r.valid){x.window.showErrorMessage(`Error processing requested file name: ${o}. Try with a different name.`);return}let n=P.Uri.joinPath(t,r.name);return e.includes(r.name)||await P.workspace.fs.writeFile(n,ee),n}var oe=S(require("path")),re=S(require("vscode")),G=require("vscode");function ht(t){let e=t.ext;return/\.R/i.test(e)}function ne(t="world"){let e=G.window.activeTextEditor;if(!e){G.window.showErrorMessage("No active file open to run ui editor on!");return}let o=oe.default.parse(e.document.fileName);if(!ht(o)){G.window.showErrorMessage(`Can't run the ui editor on the currently active file ${o.base}, needs to be a .R file.`);return}re.commands.executeCommand("vscode.openWith",e.document.uri,"shinyuieditor.appFile")}var T=S(require("vscode"));function se(t){return typeof t=="object"&&t!==null}function ie(t){return se(t)?"path"in t:!1}var ae=gt;function gt(t,e,o){var r=null,n=null,a=function(){r&&(clearTimeout(r),n=null,r=null)},s=function(){var p=n;a(),p&&p()},i=function(){if(!e)return t.apply(this,arguments);var p=this,c=arguments,l=o&&!r;if(a(),n=function(){t.apply(p,c)},r=setTimeout(function(){if(r=null,!l){var d=n;return n=null,d()}},e),l)return n()};return i.cancel=a,i.flush=s,i}var Ze=S(require("vscode"));var D=S(require("vscode"));async function ce(t){let e=t.uri,o=new D.WorkspaceEdit,r=t.validateRange(new D.Range(0,0,1/0,1/0));o.replace(e,r,""),await D.workspace.applyEdit(o),t.save()}var M=S(require("vscode"));async function pe({appFile:t,existingEditor:e}){return e&&M.window.visibleTextEditors.includes(e)?e:await M.window.showTextDocument(t.uri,{viewColumn:M.ViewColumn.Beside,preview:!0})}async function ue(t,e){let o=await t.runCmd(`print(require(${e}, quietly = TRUE))`,{verbose:!1});return o.status==="error"?{status:"error",msg:o.errorMsg}:o.values[0].includes("FALSE")?{status:"error",msg:vt(e)}:{status:"success"}}function vt(t){return`The ShinyUiEditor extension needs the \`${t}\` pkg installed. Install using \`remotes::install_github('rstudio/${t}')\` and restart the extension.`}function W(...t){return t.filter(o=>o!==void 0).reduce((o,r,n)=>(n===0?"":o+`
`)+r,"")}function le(t){return t.replace(/(?<=\\)"/g,'\\\\"').replace(/\\n/g,"\\\\n").replace(/(?<!\\)"/g,'\\"')}function de(t){return t.replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}async function fe(t,e){let o=le(e),r=W(`app_lines <- strsplit("${o}", "\\n")[[1]]`,"parsed <- parse(text = app_lines, keep.source = TRUE)","jsonlite::toJSON(","  shinyuieditor:::serialize_ast(parsed),","  auto_unbox = TRUE",")"),n=await t.runCmd(r,{verbose:!1,timeout_ms:5e3});if(n.status==="error")return n;try{let a=JSON.parse(n.values.reduce((s,i)=>s+`
`+i,""));return Object.keys(a).length===0?{status:"success",values:"EMPTY"}:{status:"success",values:a}}catch{return{status:"error",errorMsg:"Could not get document as json. Content is not valid json"}}}var ge=S(require("fs")),H=S(require("vscode"));var me=require("child_process");async function he({cmd:t,args:e,verbose:o=!1,timeout_ms:r=1500}){let n=Et(o,"runShellCommand: ");return new Promise(a=>{let s={stdout:[],stderr:[]},i=(0,me.spawn)(t,e);function p(){n("Spawned")}function c(f){n("Error "+f.message),u(),a({status:"error",errorMsgs:f.message,...s})}function l(){n("Close"),u(),a({status:"success",...s})}function d(f){n(`stdout: ${f.toString()}`),s.stdout.push(f.toString())}function g(f){n(`stderr: ${f.toString()}`),s.stderr.push(f.toString())}function u(){clearTimeout(h),i.off("spawn",p),i.off("error",c),i.off("close",l),i.stdout.off("data",d),i.stderr.off("data",g)}let h=setTimeout(()=>{a({status:"error",errorMsgs:`Command, no response from run command within ${r}ms:
${t} ${e?.join(" ")}`,...s}),u()},r);i.on("spawn",p),i.on("error",c),i.on("close",l),i.stdout.on("data",d),i.stderr.on("data",g)})}function Et(t,e){return o=>{t&&console.log(e+o)}}async function ve(t){if(yt())return await _t(t);let e=H.Uri.parse(`http://localhost:${t}`);return(await H.env.asExternalUri(e)).toString()}var Ee="/usr/lib/rstudio-server/bin/rserver-url";function yt(){return"RS_SERVER_URL"in process.env?ge.existsSync(Ee):!1}async function _t(t){let e=await he({cmd:Ee,args:[String(t)]});e.status==="error"&&Error(`Failed to get Posit workbench forwarded port. Error msg:
`+e.errorMsgs);let o=process.env.RS_SERVER_URL,r=process.env.RS_SESSION_URL;if(!o||!r)throw new Error("Can't find URL for workbench.");let n=e.stdout[0];return`${o}${r.slice(1)}p/${n}/`}var ye=S(require("net"));async function _e(){return new Promise(t=>{let e=ye.default.createServer();e.listen(0,()=>{let o=e.address?.();if(typeof o=="string"||o===null)throw new Error("Failed to find a free port...");e.close(r=>t(o.port))})})}var He=require("child_process");var Ge=require("fs");var Fe=require("fs"),Z=S(require("path")),Le=Ue();async function $e(){let t=process.platform,e=Pt(t);if(!e&&t==="win32")try{let o=new Le({hive:Le.HKLM,key:"\\Software\\R-Core\\R"}),r=await new Promise((n,a)=>o.get("InstallPath",(s,i)=>s===null?n(i):a(s)));e=Z.default.join(r.value,"bin","R.exe")}catch{e=""}return e}function Pt(t){let e=":",o="";t==="win32"&&(e=";",o=".exe");let r=process.env.PATH?process.env.PATH.split(e):[];for(let n of r){let a=Z.default.join(n,"R"+o);if((0,Fe.existsSync)(a))return a}return""}async function We(){let t=await $e();if(!t){let e="Cannot find R for running shinyuieditor. Make sure R is installed and/or updating the shinyuieditor extension settings option to proper to R path.";throw new Error(e)}if(!(0,Ge.existsSync)(t)){let e=`Path to R is invalid: ${t}. Make sure R is installed and/or updating the shinyuieditor extension settings option to proper to R path.`;throw new Error(e)}return de(t)}async function B(t,e={}){let o=await We();if(o===void 0)throw new Error("Can't get R path");let r="";return new Promise(n=>{let a=new AbortController,{signal:s}=a,i=(0,He.spawn)(o,t,{signal:s});i.on("spawn",l),i.on("error",d),i.on("close",g),i.stdout.on("data",u),i.stderr.on("data",h);function p(v,y){r+=`${v}: ${y}`}function c(v){e.verbose&&console.log(`%c[RProc ${i.pid}] %c${v.replaceAll(/\n$/g,"").replaceAll(/\n/g,`
\u2219\u2219\u2219 `)}`,"color: orangered;","color: grey; opacity: 0.5")}function l(){c("spawned"),clearTimeout(w),n({proc:i,stop:E,getIsRunning:()=>i.exitCode===null})}function d(v){c(`Error: 
${v.toString()}`),clearTimeout(w),e.onError?.(v)}function g(){c("Closed"),clearTimeout(w),e.onClose?.()}function u(v){let y=v.toString();c(`stdout: 
${y}`),p("out",y),e.onStdout?.(y)}function h(v){let y=v.toString();c(`stderr: ${y}`),p("error",y),e.onStderr?.(y)}function f(){i.off("spawn",l),i.off("error",d),i.off("close",g),i.stdout.off("data",u),i.stderr.off("data",h)}function E(){return f(),!i.pid||!i.connected?!0:(c(`Killing R process ${i.pid}`),process.kill(i.pid))}let w=setTimeout(()=>{throw E(),new Error(`Starting backend server failed.
 Logs:
`+r)},e.timeout_ms??5e3)})}function Be({pathToApp:t,onCrash:e,onInitiation:o,onReady:r,onFailToStart:n,onLogs:a}){let s="0.0.0.0",i=null;async function p(){o(),c();try{let l=await _e(),d=await ve(l),g=new RegExp(`listening on .+${l}`,"i"),u=W("options(shiny.autoreload = TRUE)",`shiny::runApp(appDir = "${t}", port = ${l}, host = "${s}")`);return i=await B(["--no-save","--no-restore","--silent","-e",u],{onStderr(h){g.test(h)&&r(d.toString()),a(h.split(`
`))},onClose:e,onError:e}),!0}catch{return n(),!1}}function c(){return i===null?!0:i.stop()}return{start:p,stop:c}}var _=S(require("vscode"));var K=S(require("vscode"));async function Ke({uri:t,position:e=new K.Position(0,0),locations:o,multiple:r="gotoAndPeek",noResultsMessage:n}){await K.commands.executeCommand("editor.action.goToLocations",t,e,o,r,n)}async function Ye({editor:t,snippet:e,below_line:o}){let r=t.document.validatePosition(new _.Position(o-1,1/0));await t.insertSnippet(new _.SnippetString(`
`+e),r)||_.window.showErrorMessage("Failed to add output scaffold")}function Ve({editor:t,selections:e}){let o=e.map(([r,n,a,s])=>{let i=new _.Position(r-1,n-1),p=new _.Position(a-1,s);return new _.Selection(i,p)});t.selection=o[0],t.revealRange(o[0])}async function qe({editor:t,input:{inputId:e}}){let o=`input$${e}`,r=o,a=t.document.getText().split(`
`),s=new RegExp(`(?<!#.*)${At(r)}(?=\\W)`),i=a.map((c,l)=>({line:l,match:s.exec(c)})).filter(({match:c})=>c!==null);if(i.length===0)return null;let p=i.map(({line:c,match:l})=>{let d=l?.index??0,g=new _.Position(c,d),u=new _.Position(c,d+r.length);return new _.Location(t.document.uri,new _.Range(g,u))});_.window.showTextDocument(t.document),await Ke({uri:t.document.uri,locations:p,noResultsMessage:`Failed to find any current use of ${o} in server`})}function At(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var N=S(require("vscode"));async function je({script_text:t,document:e}){let o=e.getText();if(t===o)return!1;let r=e.uri,n=new N.WorkspaceEdit,a=e.validateRange(new N.Selection(0,0,e.lineCount+1,0));return n.replace(r,a,t),await N.workspace.applyEdit(n),e.save(),!0}var{showErrorMessage:Qe}=Ze.window;function Xe({RProcess:t,document:e,sendMessage:o}){let r=!1,n=null,a,s=async()=>{let u=e.getText(),h=n!==null&&u.includes(n);if(!r){let f=await ue(t,"shinyuieditor");if(f.status==="error")throw o({path:"BACKEND-ERROR",payload:{context:"checking for shinyuieditor package",msg:f.msg}}),Qe(f.msg),new Error(f.msg);r=!0}if(u===""){o({path:"TEMPLATE_CHOOSER",payload:"SINGLE-FILE"});return}try{let f=await fe(t,u);if(f.status==="error"){o({path:"BACKEND-ERROR",payload:{context:"parsing app",msg:f.errorMsg}}),Qe(f.errorMsg);return}if(f.values==="EMPTY"){o({path:"TEMPLATE_CHOOSER",payload:"SINGLE-FILE"});return}n=u,o({path:"APP-INFO",payload:{app_type:"SINGLE-FILE",app:{script:u,ast:f.values}}})}catch(f){console.error("Failed to parse",f)}},i=ae(s,500),p=()=>{i()},c=()=>{i.flush()},l=Be({pathToApp:e.fileName,onInitiation:()=>{o({path:"APP-PREVIEW-STATUS",payload:"LOADING"})},onReady:u=>{o({path:"APP-PREVIEW-STATUS",payload:{url:u}})},onFailToStart:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Failed to start"})},onCrash:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Crashed"})},onLogs:u=>{o({path:"APP-PREVIEW-LOGS",payload:u})}}),d=async()=>(a=await pe({appFile:e,existingEditor:a}),a);return{onDocumentChanged:p,onDocumentSaved:c,onDidReceiveMessage:async u=>{if(ie(u))switch(u.path){case"READY-FOR-STATE":s();return;case"UPDATED-APP":{if(u.payload.app_type==="MULTI-FILE")return;await je({script_text:u.payload.app,document:e})&&(n=u.payload.app);return}case"APP-PREVIEW-REQUEST":{l.start();return}case"APP-PREVIEW-STOP":{l.stop();return}case"APP-PREVIEW-RESTART":{l.start();return}case"ENTERED-TEMPLATE-SELECTOR":{l.stop(),await ce(e);return}case"OPEN-COMPANION-EDITOR":{await d();return}case"SHOW-APP-LINES":{Ve({editor:await d(),selections:u.payload});return}case"INSERT-SNIPPET":{console.log("Insert snippet into server",u.payload),Ye({editor:await d(),...u.payload});return}case"FIND-INPUT-USES":{qe({editor:await d(),input:u.payload});return}case"NODE-SELECTION":{console.log("New node selection",u.payload);return}default:console.warn("Unhandled message from client",u)}else console.log("Unknown message from webview",u)}}}function ze(t){let e=t.getText();return e.trim()===""?"empty":Ct.test(e)?"valid":"invalid"}var Ct=/shinyApp\(/;var Je="SUE_START_SIGNAL",et="SUE_END_SIGNAL";async function tt(t,e,{timeout_ms:o=1e3,verbose:r=!1}={}){let n=p=>{r&&console.log(`runRCommand: ${p}`)},a="",s=!1,i=[];return t.exitCode!==null?{status:"error",errorMsg:`Can't run R command as background R process has exited with code ${t.exitCode}.`}:new Promise(p=>{function c(h){let E=h.toString().split(`
`);n("~~~Output chunk~~~");for(let w of E){let v=w.includes(Je),y=w.includes(et),F=w.length===0;if(v){s=!0;continue}if(y){clearTimeout(g),p({status:"success",values:i}),n("Output finished"),u();break}!s||F||(n(w),a+=w+`
`,i.push(w))}}function l(h){let f=h.toString();a+=`stderr: ${f}
`,n("stderr: "+f)}function d(){p({status:"error",errorMsg:a}),u()}t.stdout.on("data",c),t.stderr.on("data",l),t.on("close",d);let g=setTimeout(()=>{p({status:"error",errorMsg:`Timeout, no response from run command within ${o}ms: ${e}
 Logs:
 ${a}`}),u()},o);function u(){t.stdout.off("data",c),t.stderr.off("data",l),t.off("close",d)}ot(`print('${Je}');${e};print('${et}')`,t)})}async function rt(){async function t(){return await B(["--silent","--slave","--no-save","--no-restore"],{timeout_ms:5e3})}let e=await t();return{...e,async runCmd(o,r){return e.getIsRunning()||(console.warn("Background R Process has crashed. Restarting..."),e.stop(),e=await t(),console.warn("Background R Process restarted")),tt(e.proc,o,r)}}}function ot(t,e){e.stdin.write(`${t}
`)}function nt(){let t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<32;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}var Y=class{constructor(e){this.context=e;this.RProcess=null;rt().then(o=>{this.RProcess=o})}static register(e){let o=new Y(e);return T.window.registerCustomEditorProvider(Y.viewType,o,{webviewOptions:{retainContextWhenHidden:!0}})}async resolveCustomTextEditor(e,o,r){if(ze(e)==="invalid"){let c="The active file doesn't appear to be a Shiny app. Make sure that the script is either empty or has a valid shiny app in it.";throw T.window.showErrorMessage(c),o.dispose(),new Error(c)}if(o.webview.options={enableScripts:!0},o.webview.html=this.getHtmlForWebview(o.webview),!this.RProcess)throw new Error("Don't have an R Process to pass to editor backend!");let a=Xe({RProcess:this.RProcess,document:e,sendMessage:c=>o.webview.postMessage(c)}),s=T.workspace.onDidChangeTextDocument(c=>{c.document.uri.toString()===e.uri.toString()&&a.onDocumentChanged()}),i=T.workspace.onDidSaveTextDocument(c=>{c.uri.toString()===e.uri.toString()&&a.onDocumentSaved()}),p=o.webview.onDidReceiveMessage(a.onDidReceiveMessage);o.onDidDispose(()=>{s.dispose(),i.dispose(),p.dispose()})}getHtmlForWebview(e){let o=e.asWebviewUri(T.Uri.joinPath(this.context.extensionUri,"media","build","extension-editor.js")),r=e.asWebviewUri(T.Uri.joinPath(this.context.extensionUri,"media","build","style.css")),n=nt(),a=e.cspSource;return`
			<!DOCTYPE html>
			<html lang="en">
			<head>
				<meta charset="UTF-8">
				<script>
				// This is needed for various older packages that require the global
				// object to be defined because it typically was with older bundlers like
				// webpack
				var global = window;
			  </script>
				<!--
				Use a content security policy to only allow loading images from https or from our extension directory,
				and only allow scripts that have a specific nonce.
				-->
				<meta 
          http-equiv="Content-Security-Policy" 
          content="default-src 'none'; frame-src http://localhost:*/ ${a} https:; img-src ${a} data:; style-src ${e.cspSource} 'unsafe-inline'; script-src 'nonce-${n}';">

				<meta name="viewport" content="width=device-width, initial-scale=1.0">

				
				<link href="${r}" rel="stylesheet" />
				
				<title>Shiny UI Editor</title>
			</head>
			<body style="padding-inline: 0;">
				<noscript>You need to enable JavaScript to run this app.</noscript>
				<div id="root" style="height: 100vh; display: relative"></div>
				<script type="module" nonce="${n}" src="${o}"></script>
			</body>
			</html>`}},L=Y;L.viewType="shinyuieditor.appFile";function It(t){t.subscriptions.push(L.register(t)),t.subscriptions.push(X.commands.registerCommand("shinyuieditor.startEditorOnActiveFile",ne),X.commands.registerCommand("shinyuieditor.launchEditor",te))}0&&(module.exports={activate});
