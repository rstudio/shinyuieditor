"use strict";var dt=Object.create;var $=Object.defineProperty;var ft=Object.getOwnPropertyDescriptor;var _t=Object.getOwnPropertyNames;var mt=Object.getPrototypeOf,gt=Object.prototype.hasOwnProperty;var vt=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),ht=(t,e)=>{for(var o in e)$(t,o,{get:e[o],enumerable:!0})},ne=(t,e,o,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of _t(e))!gt.call(t,r)&&r!==o&&$(t,r,{get:()=>e[r],enumerable:!(n=ft(e,r))||n.enumerable});return t};var w=(t,e,o)=>(o=t!=null?dt(mt(t)):{},ne(e||!t||!t.__esModule?$(o,"default",{value:t,enumerable:!0}):o,t)),yt=t=>ne($({},"__esModule",{value:!0}),t);var He=vt((wo,Ke)=>{var X=require("util"),kt=require("path"),P=require("child_process").spawn,S=function(){},z="HKLM",Ce="HKCU",Ie="HKCR",be="HKU",ke="HKCC",Oe=[z,Ce,Ie,be,ke],De="REG_SZ",Me="REG_MULTI_SZ",Le="REG_EXPAND_SZ",Ue="REG_DWORD",Fe="REG_QWORD",Ge="REG_BINARY",$e="REG_NONE",Be=[De,Me,Le,Ue,Fe,Ge,$e],Ot="",Dt=/(\\[a-zA-Z0-9_\s]+)*/,Mt=/^(HKEY_LOCAL_MACHINE|HKEY_CURRENT_USER|HKEY_CLASSES_ROOT|HKEY_USERS|HKEY_CURRENT_CONFIG)(.*)$/,We=/^(.*)\s(REG_SZ|REG_MULTI_SZ|REG_EXPAND_SZ|REG_DWORD|REG_QWORD|REG_BINARY|REG_NONE)\s+([^\s].*)$/;function D(t,e){if(!(this instanceof D))return new D(t,e);Error.captureStackTrace(this,D),this.__defineGetter__("name",function(){return D.name}),this.__defineGetter__("message",function(){return t}),this.__defineGetter__("code",function(){return e})}X.inherits(D,Error);function N(t){var e={stdout:"",stderr:""};return t.stdout.on("data",function(o){e.stdout+=o.toString()}),t.stderr.on("data",function(o){e.stderr+=o.toString()}),e}function C(t,e,o){var n=o.stdout.trim(),r=o.stderr.trim(),s=X.format(`%s command exited with code %d:
%s
%s`,t,e,n,r);return new D(s,e)}function Lt(t){if(t=="x64")return"64";if(t=="x86")return"32";throw new Error("illegal architecture: "+t+" (use x86 or x64)")}function I(t,e){e&&t.push("/reg:"+Lt(e))}function b(){return process.platform==="win32"?kt.join(process.env.windir,"system32","reg.exe"):"REG"}function U(t,e,o,n,r,s,i){if(!(this instanceof U))return new U(t,e,o,n,r,s,i);var a=t,c=e,p=o,d=n,l=r,v=s,f=i;this.__defineGetter__("host",function(){return a}),this.__defineGetter__("hive",function(){return c}),this.__defineGetter__("key",function(){return p}),this.__defineGetter__("name",function(){return d}),this.__defineGetter__("type",function(){return l}),this.__defineGetter__("value",function(){return v}),this.__defineGetter__("arch",function(){return f})}X.inherits(U,Object);function m(t){if(!(this instanceof m))return new m(t);var e=t||{},o=""+(e.host||""),n=""+(e.hive||z),r=""+(e.key||""),s=e.arch||null;if(this.__defineGetter__("host",function(){return o}),this.__defineGetter__("hive",function(){return n}),this.__defineGetter__("key",function(){return r}),this.__defineGetter__("path",function(){return(o.length==0?"":"\\\\"+o+"\\")+n+r}),this.__defineGetter__("arch",function(){return s}),this.__defineGetter__("parent",function(){var i=r.lastIndexOf("\\");return new m({host:this.host,hive:this.hive,key:i==-1?"":r.substring(0,i),arch:this.arch})}),Oe.indexOf(n)==-1)throw new Error("illegal hive specified.");if(!Dt.test(r))throw new Error("illegal key specified.");if(s&&s!="x64"&&s!="x86")throw new Error("illegal architecture specified (use x86 or x64)")}m.HKLM=z;m.HKCU=Ce;m.HKCR=Ie;m.HKU=be;m.HKCC=ke;m.HIVES=Oe;m.REG_SZ=De;m.REG_MULTI_SZ=Me;m.REG_EXPAND_SZ=Le;m.REG_DWORD=Ue;m.REG_QWORD=Fe;m.REG_BINARY=Ge;m.REG_NONE=$e;m.REG_TYPES=Be;m.DEFAULT_VALUE=Ot;m.prototype.values=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r="",s=this,i=null,a=N(n);return n.on("close",function(c){if(!i)if(c!==0)S("process exited with code "+c),e(C("QUERY",c,a),null);else{for(var p=[],d=[],l=r.split(`
`),v=0,f=0,u=l.length;f<u;f++){var _=l[f].trim();_.length>0&&(S(_),v!=0&&p.push(_),++v)}for(var f=0,u=p.length;f<u;f++){var g=We.exec(p[f]),R,h,y;g&&(R=g[1].trim(),h=g[2].trim(),y=g[3],d.push(new U(s.host,s.hive,s.key,R,h,y,s.arch)))}e(null,d)}}),n.stdout.on("data",function(c){r+=c.toString()}),n.on("error",function(c){i=c,e(c)}),this};m.prototype.keys=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["QUERY",this.path];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r="",s=this,i=null,a=N(n);return n.on("close",function(c){i||c!==0&&(S("process exited with code "+c),e(C("QUERY",c,a),null))}),n.stdout.on("data",function(c){r+=c.toString()}),n.stdout.on("end",function(){for(var c=[],p=[],d=r.split(`
`),l=0,v=d.length;l<v;l++){var f=d[l].trim();f.length>0&&(S(f),c.push(f))}for(var l=0,v=c.length;l<v;l++){var u=Mt.exec(c[l]),_,g;u&&(_=u[1],g=u[2],g&&g!==s.key&&p.push(new m({host:s.host,hive:s.hive,key:g,arch:s.arch})))}e(null,p)}),n.on("error",function(c){i=c,e(c)}),this};m.prototype.get=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var n=["QUERY",this.path];e==""?n.push("/ve"):n=n.concat(["/v",e]),I(n,this.arch);var r=P(b(),n,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),s="",i=this,a=null,c=N(r);return r.on("close",function(p){if(!a)if(p!==0)S("process exited with code "+p),o(C("QUERY",p,c),null);else{for(var d=[],l=null,v=s.split(`
`),f=0,u=0,_=v.length;u<_;u++){var g=v[u].trim();g.length>0&&(S(g),f!=0&&d.push(g),++f)}var R=d[d.length-1]||"",h=We.exec(R),y,G,oe;h&&(y=h[1].trim(),G=h[2].trim(),oe=h[3],l=new U(i.host,i.hive,i.key,y,G,oe,i.arch)),o(null,l)}}),r.stdout.on("data",function(p){s+=p.toString()}),r.on("error",function(p){a=p,o(p)}),this};m.prototype.set=function(e,o,n,r){if(typeof r!="function")throw new TypeError("must specify a callback");if(Be.indexOf(o)==-1)throw Error("illegal type specified.");var s=["ADD",this.path];e==""?s.push("/ve"):s=s.concat(["/v",e]),s=s.concat(["/t",o,"/d",n,"/f"]),I(s,this.arch);var i=P(b(),s,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),a=null,c=N(i);return i.on("close",function(p){a||(p!==0?(S("process exited with code "+p),r(C("ADD",p,c,null))):r(null))}),i.stdout.on("data",function(p){S(""+p)}),i.on("error",function(p){a=p,r(p)}),this};m.prototype.remove=function(e,o){if(typeof o!="function")throw new TypeError("must specify a callback");var n=e?["DELETE",this.path,"/f","/v",e]:["DELETE",this.path,"/f","/ve"];I(n,this.arch);var r=P(b(),n,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),s=null,i=N(r);return r.on("close",function(a){s||(a!==0?(S("process exited with code "+a),o(C("DELETE",a,i),null)):o(null))}),r.stdout.on("data",function(a){S(""+a)}),r.on("error",function(a){s=a,o(a)}),this};m.prototype.clear=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f","/va"];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r=null,s=N(n);return n.on("close",function(i){r||(i!==0?(S("process exited with code "+i),e(C("DELETE",i,s),null)):e(null))}),n.stdout.on("data",function(i){S(""+i)}),n.on("error",function(i){r=i,e(i)}),this};m.prototype.erase=m.prototype.clear;m.prototype.destroy=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["DELETE",this.path,"/f"];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r=null,s=N(n);return n.on("close",function(i){r||(i!==0?(S("process exited with code "+i),e(C("DELETE",i,s),null)):e(null))}),n.stdout.on("data",function(i){S(""+i)}),n.on("error",function(i){r=i,e(i)}),this};m.prototype.create=function(e){if(typeof e!="function")throw new TypeError("must specify a callback");var o=["ADD",this.path,"/f"];I(o,this.arch);var n=P(b(),o,{cwd:void 0,env:process.env,stdio:["ignore","pipe","pipe"]}),r=null,s=N(n);return n.on("close",function(i){r||(i!==0?(S("process exited with code "+i),e(C("ADD",i,s),null)):e(null))}),n.stdout.on("data",function(i){S(""+i)}),n.on("error",function(i){r=i,e(i)}),this};m.prototype.keyExists=function(e){return this.values(function(o,n){if(o)return o.code==1?e(null,!1):e(o);e(null,!0)}),this};m.prototype.valueExists=function(e,o){return this.get(e,function(n,r){if(n)return n.code==1?o(null,!1):o(n);o(null,!0)}),this};Ke.exports=m});var Bt={};ht(Bt,{activate:()=>$t});module.exports=yt(Bt);var te=w(require("vscode"));var A=require("vscode"),T=w(require("vscode"));var j="app.R",Et=/^([\w|\s]+)([\.[\w|^\.]*]*)$/i;function Q(t){if(t==="")return{valid:!0,name:j};let e=t.match(Et);if(e===null)return{valid:!1,msg:`Invalid app name: ${t}.`};let[o,n,r]=e;return(r===""||r===".")&&(r=".R"),n?r!==".R"?{valid:!1,msg:`Invalid file extension: ${r}. Extension needs to be .R`}:(n=n.replaceAll(" ","-"),{valid:!0,name:`${n}${r}`}):{valid:!1,msg:`Invalid app name: ${t}. Make sure to only use numbers and letters. Spaces will be converted to dashes.`}}var re=new TextEncoder().encode("");async function se(){let t=await A.window.showOpenDialog({canSelectFolders:!0,canSelectFiles:!0,title:"Choose location for Shiny app",openLabel:"Choose app folder or file",canSelectMany:!1,filters:{"R scripts":["R","r"]}});if(!t)return;let e=t[0],n=(await T.workspace.fs.stat(e)).type===T.FileType.Directory?await St(e):e;n&&T.commands.executeCommand("vscode.openWith",n,"shinyuieditor.appFile")}async function St(t){let e=(await A.workspace.fs.readDirectory(t)).filter(([i,a])=>a===T.FileType.File).map(([i,a])=>i),o=await A.window.showInputBox({prompt:"Enter file name for new app",placeHolder:j,validateInput(i){let a=Q(i);return a.valid?e.includes(a.name)?{message:`Run the editor on existing app: ${a.name}.`,severity:T.InputBoxValidationSeverity.Info}:{message:`Run the template chooser to build new app: ${a.name}.`,severity:T.InputBoxValidationSeverity.Info}:{message:a.msg,severity:T.InputBoxValidationSeverity.Error}}});if(!o)return;let n=Q(o);if(!n.valid){T.window.showErrorMessage(`Error processing requested file name: ${o}. Try with a different name.`);return}let r=A.Uri.joinPath(t,n.name);return e.includes(n.name)||await A.workspace.fs.writeFile(r,re),r}var ie=w(require("path")),ae=w(require("vscode")),B=require("vscode");function Rt(t){let e=t.ext;return/\.R/i.test(e)}function pe(t="world"){let e=B.window.activeTextEditor;if(!e){B.window.showErrorMessage("No active file open to run ui editor on!");return}let o=ie.default.parse(e.document.fileName);if(!Rt(o)){B.window.showErrorMessage(`Can't run the ui editor on the currently active file ${o.base}, needs to be a .R file.`);return}ae.commands.executeCommand("vscode.openWith",e.document.uri,"shinyuieditor.appFile")}var x=w(require("vscode"));function ce(t){return typeof t=="object"&&t!==null}function ue(t){return ce(t)?"path"in t:!1}var le=wt;function wt(t,e,o){var n=null,r=null,s=function(){n&&(clearTimeout(n),r=null,n=null)},i=function(){var c=r;s(),c&&c()},a=function(){if(!e)return t.apply(this,arguments);var c=this,p=arguments,d=o&&!n;if(s(),r=function(){t.apply(c,p)},n=setTimeout(function(){if(n=null,!d){var l=r;return r=null,l()}},e),d)return r()};return a.cancel=s,a.flush=i,a}var nt=w(require("vscode"));var k=w(require("vscode"));async function de(t){let e=t.uri,o=new k.WorkspaceEdit,n=t.validateRange(new k.Range(0,0,1/0,1/0));o.replace(e,n,""),await k.workspace.applyEdit(o),t.save()}var L=w(require("vscode"));async function fe({appFile:t,existingEditor:e}){return e&&L.window.visibleTextEditors.includes(e)?e:await L.window.showTextDocument(t.uri,{viewColumn:L.ViewColumn.Beside,preview:!0})}async function _e(t,e){let o=await t.runCmd(`print(require(${e}, quietly = TRUE))`,{verbose:!1});return o.status==="error"?{status:"error",msg:o.errorMsg}:o.values[0].includes("FALSE")?{status:"error",msg:Tt(e)}:{status:"success"}}function Tt(t){return`The ShinyUiEditor extension needs the \`${t}\` pkg installed. Install using \`remotes::install_github('rstudio/${t}')\` and restart the extension.`}var O=class extends Error{constructor({message:o,cause:n}){super();this.name="AST_PARSING_ERROR",this.message=o,this.cause=n}};function W(t){return t.type==="e"&&Array.isArray(t.val)}function xt(t,e){if(!W(t))return!1;let{val:o}=t;return o[0].val==="<-"||o[0].val==="="?e?o[1].val===e:!0:!1}function At(t){return t.val[1]}function Z(t){let e=[];return t.forEach(o=>{if(xt(o)){let n=At(o);Pt(n)?e.push({name:n.val[2].val,is_output:!0,node:o}):n.type==="s"&&e.push({name:n.val,is_output:!1,node:o})}if(W(o)){let n=Z(o.val);e.push(...n)}}),e}function Pt(t){if(!W(t))return!1;let{val:e}=t;return e.length===3&&e[1].val==="output"&&typeof e[2].val=="string"}function me(t){return t.filter(({is_output:e})=>e).reduce((e,{name:o,node:n})=>{let{pos:r}=n;return r&&(e[o]=[...e[o]??[],r]),e},{})}function ge(t){let e=t.find(({name:n,is_output:r})=>n==="server"&&!r);if(!e)throw new O({message:"No server assignment node was found in provided ast"});let{node:o}=e;if(!o.pos)throw new O({message:"No position info attached to the ui assignment node",cause:o});return o}function ve(t){let e=Z(t),o=ge(e).pos,n=me(e);return{app_type:"SINGLE-FILE",server_pos:o,get_output_position:s=>s in n?n[s]:null}}function K(...t){return t.filter(o=>o!==void 0).reduce((o,n,r)=>(r===0?"":o+`
`)+n,"")}function he(t){return t.replace(/(?<=\\)"/g,'\\\\"').replace(/\\n/g,"\\\\n").replace(/(?<!\\)"/g,'\\"')}function ye(t){return t.replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function Ee(t,e){let o=" ".repeat(e);return t.replaceAll(/\n/g,`
${o}`)}async function Nt(t,e){let o=he(e),n=K(`app_lines <- strsplit("${o}", "\\n")[[1]]`,"parsed <- parse(text = app_lines, keep.source = TRUE)","jsonlite::toJSON(","  shinyuieditor:::serialize_ast(parsed),","  auto_unbox = TRUE",")"),r=await t.runCmd(n,{verbose:!1,timeout_ms:5e3});if(r.status==="error")return r;try{let s=JSON.parse(r.values.reduce((a,c)=>a+`
`+c,""));if(Object.keys(s).length===0)return{status:"success",values:"EMPTY"};let i=ve(s);return{status:"success",values:{ast:s,server_info:i}}}catch{return{status:"error",errorMsg:"Could not get document as json. Content is not valid json"}}}function Se(t,e){let o=null;async function n(){let r=t.version;if(r===o?.file_version)return{status:"success",values:o.ast_info};let s=await Nt(e,t.getText());if(s.status==="error")return s;let i=s.values;return o={file_version:r,ast_info:i},s}return n}var Te=w(require("fs")),H=w(require("vscode"));var Re=require("child_process");async function we({cmd:t,args:e,verbose:o=!1,timeout_ms:n=1500}){let r=Ct(o,"runShellCommand: ");return new Promise(s=>{let i={stdout:[],stderr:[]},a=(0,Re.spawn)(t,e);function c(){r("Spawned")}function p(_){r("Error "+_.message),f(),s({status:"error",errorMsgs:_.message,...i})}function d(){r("Close"),f(),s({status:"success",...i})}function l(_){r(`stdout: ${_.toString()}`),i.stdout.push(_.toString())}function v(_){r(`stderr: ${_.toString()}`),i.stderr.push(_.toString())}function f(){clearTimeout(u),a.off("spawn",c),a.off("error",p),a.off("close",d),a.stdout.off("data",l),a.stderr.off("data",v)}let u=setTimeout(()=>{s({status:"error",errorMsgs:`Command, no response from run command within ${n}ms:
${t} ${e?.join(" ")}`,...i}),f()},n);a.on("spawn",c),a.on("error",p),a.on("close",d),a.stdout.on("data",l),a.stderr.on("data",v)})}function Ct(t,e){return o=>{t&&console.log(e+o)}}async function xe(t){if(It())return await bt(t);let e=H.Uri.parse(`http://localhost:${t}`);return(await H.env.asExternalUri(e)).toString()}var Ae="/usr/lib/rstudio-server/bin/rserver-url";function It(){return"RS_SERVER_URL"in process.env?Te.existsSync(Ae):!1}async function bt(t){let e=await we({cmd:Ae,args:[String(t)]});e.status==="error"&&Error(`Failed to get Posit workbench forwarded port. Error msg:
`+e.errorMsgs);let o=process.env.RS_SERVER_URL,n=process.env.RS_SESSION_URL;if(!o||!n)throw new Error("Can't find URL for workbench.");let r=e.stdout[0];return`${o}${n.slice(1)}p/${r}/`}var Pe=w(require("net"));async function Ne(){return new Promise(t=>{let e=Pe.default.createServer();e.listen(0,()=>{let o=e.address?.();if(typeof o=="string"||o===null)throw new Error("Failed to find a free port...");e.close(n=>t(o.port))})})}var Ze=require("child_process");var je=require("fs");var Ye=require("fs"),J=w(require("path")),Ve=He();async function qe(){let t=process.platform,e=Ut(t);if(!e&&t==="win32")try{let o=new Ve({hive:Ve.HKLM,key:"\\Software\\R-Core\\R"}),n=await new Promise((r,s)=>o.get("InstallPath",(i,a)=>i===null?r(a):s(i)));e=J.default.join(n.value,"bin","R.exe")}catch{e=""}return e}function Ut(t){let e=":",o="";t==="win32"&&(e=";",o=".exe");let n=process.env.PATH?process.env.PATH.split(e):[];for(let r of n){let s=J.default.join(r,"R"+o);if((0,Ye.existsSync)(s))return s}return""}async function Qe(){let t=await qe();if(!t){let e="Cannot find R for running shinyuieditor. Make sure R is installed and/or updating the shinyuieditor extension settings option to proper to R path.";throw new Error(e)}if(!(0,je.existsSync)(t)){let e=`Path to R is invalid: ${t}. Make sure R is installed and/or updating the shinyuieditor extension settings option to proper to R path.`;throw new Error(e)}return ye(t)}async function V(t,e={}){let o=await Qe();if(o===void 0)throw new Error("Can't get R path");let n="";return new Promise(r=>{let s=new AbortController,{signal:i}=s,a=(0,Ze.spawn)(o,t,{signal:i});a.on("spawn",d),a.on("error",l),a.on("close",v),a.stdout.on("data",f),a.stderr.on("data",u);function c(h,y){n+=`${h}: ${y}`}function p(h){e.verbose&&console.log(`%c[RProc ${a.pid}] %c${h.replaceAll(/\n$/g,"").replaceAll(/\n/g,`
\u2219\u2219\u2219 `)}`,"color: orangered;","color: grey; opacity: 0.5")}function d(){p("spawned"),clearTimeout(R),r({proc:a,stop:g,getIsRunning:()=>a.exitCode===null})}function l(h){p(`Error: 
${h.toString()}`),clearTimeout(R),e.onError?.(h)}function v(){p("Closed"),clearTimeout(R),e.onClose?.()}function f(h){let y=h.toString();p(`stdout: 
${y}`),c("out",y),e.onStdout?.(y)}function u(h){let y=h.toString();p(`stderr: ${y}`),c("error",y),e.onStderr?.(y)}function _(){a.off("spawn",d),a.off("error",l),a.off("close",v),a.stdout.off("data",f),a.stderr.off("data",u)}function g(){return _(),!a.pid||!a.connected?!0:(p(`Killing R process ${a.pid}`),process.kill(a.pid))}let R=setTimeout(()=>{throw g(),new Error(`Starting backend server failed.
 Logs:
`+n)},e.timeout_ms??5e3)})}function Xe({pathToApp:t,onCrash:e,onInitiation:o,onReady:n,onFailToStart:r,onLogs:s}){let i="0.0.0.0",a=null;async function c(){o(),p();try{let d=await Ne(),l=await xe(d),v=new RegExp(`listening on .+${d}`,"i"),f=K("options(shiny.autoreload = TRUE)",`shiny::runApp(appDir = "${t}", port = ${d}, host = "${i}")`);return a=await V(["--no-save","--no-restore","--silent","-e",f],{onStderr(u){v.test(u)&&n(l.toString()),s(u.split(`
`))},onClose:e,onError:e}),!0}catch{return r(),!1}}function p(){return a===null?!0:a.stop()}return{start:c,stop:p}}var E=w(require("vscode"));var Y=w(require("vscode"));async function ze({uri:t,position:e=new Y.Position(0,0),locations:o,multiple:n="gotoAndPeek",noResultsMessage:r}){await Y.commands.executeCommand("editor.action.goToLocations",t,e,o,n,r)}async function Je({editor:t,snippet:e,server_pos:o,where_in_server:n}){let[s,,i]=o,a=t.document.validatePosition(new E.Position(n==="end"?i-2:s-2,1/0));await t.insertSnippet(new E.SnippetString(`
  ${Ee(e,2)}`),a)||E.window.showErrorMessage("Failed to add output scaffold")}function ee({editor:t,selections:e}){let o=e.map(([n,r,s,i])=>{let a=new E.Position(n-1,r-1),c=new E.Position(s-1,i);return new E.Selection(a,c)});t.selection=o[0],t.revealRange(o[0])}async function et({editor:t,input:{inputId:e}}){let o=`input$${e}`,n=o,s=t.document.getText().split(`
`),i=new RegExp(`(?<!#.*)${Ft(n)}(?=\\W)`),a=s.map((p,d)=>({line:d,match:i.exec(p)})).filter(({match:p})=>p!==null);if(a.length===0)return null;let c=a.map(({line:p,match:d})=>{let l=d?.index??0,v=new E.Position(p,l),f=new E.Position(p,l+n.length);return new E.Location(t.document.uri,new E.Range(v,f))});E.window.showTextDocument(t.document),await ze({uri:t.document.uri,locations:c,noResultsMessage:`Failed to find any current use of ${o} in server`})}function Ft(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var M=w(require("vscode"));async function tt({script_text:t,document:e}){let o=e.getText();if(t===o)return!1;let n=e.uri,r=new M.WorkspaceEdit,s=e.validateRange(new M.Selection(0,0,e.lineCount+1,0));return r.replace(n,s,t),await M.workspace.applyEdit(r),e.save(),!0}var{showErrorMessage:ot}=nt.window;function rt({RProcess:t,document:e,sendMessage:o}){let n=!1,r=null,s,i=Se(e,t),a=async()=>{let u=e.getText();if(!(r!==null&&u.includes(r))){if(!n){let g=await _e(t,"shinyuieditor");if(g.status==="error")throw o({path:"BACKEND-ERROR",payload:{context:"checking for shinyuieditor package",msg:g.msg}}),ot(g.msg),new Error(g.msg);n=!0}if(u===""){o({path:"TEMPLATE_CHOOSER",payload:"SINGLE-FILE"});return}try{let g=await i();if(g.status==="error"){o({path:"BACKEND-ERROR",payload:{context:"parsing app",msg:g.errorMsg}}),ot(g.errorMsg);return}if(g.values==="EMPTY"){o({path:"TEMPLATE_CHOOSER",payload:"SINGLE-FILE"});return}r=u,o({path:"APP-INFO",payload:{app_type:"SINGLE-FILE",app:{script:u,ast:g.values.ast}}})}catch(g){console.error("Failed to parse",g)}}},c=le(a,500),p=()=>{c()},d=()=>{c.flush()},l=Xe({pathToApp:e.fileName,onInitiation:()=>{o({path:"APP-PREVIEW-STATUS",payload:"LOADING"})},onReady:u=>{o({path:"APP-PREVIEW-STATUS",payload:{url:u}})},onFailToStart:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Failed to start"})},onCrash:()=>{o({path:"APP-PREVIEW-CRASH",payload:"Crashed"})},onLogs:u=>{o({path:"APP-PREVIEW-LOGS",payload:u})}}),v=async()=>(s=await fe({appFile:e,existingEditor:s}),s);return{onDocumentChanged:p,onDocumentSaved:d,onDidReceiveMessage:async u=>{if(ue(u))switch(u.path){case"READY-FOR-STATE":a();return;case"UPDATED-APP":{if(u.payload.app_type==="MULTI-FILE")return;await tt({script_text:u.payload.app,document:e})&&(r=u.payload.app);return}case"APP-PREVIEW-REQUEST":{l.start();return}case"APP-PREVIEW-STOP":{l.stop();return}case"APP-PREVIEW-RESTART":{l.start();return}case"ENTERED-TEMPLATE-SELECTOR":{l.stop(),await de(e);return}case"OPEN-COMPANION-EDITOR":{await v();return}case"SHOW-APP-LINES":{ee({editor:await v(),selections:u.payload});return}case"INSERT-SNIPPET":{let _=await i();_.status==="success"&&_.values!=="EMPTY"&&Je({editor:await v(),server_pos:_.values.server_info.server_pos,...u.payload});return}case"FIND-SERVER-USES":{if(u.payload.type==="Input")et({editor:await v(),input:u.payload});else{let _=await i();_.status==="success"&&_.values!=="EMPTY"&&ee({editor:await v(),selections:_.values.server_info.get_output_position(u.payload.outputId)??[]})}return}default:console.warn("Unhandled message from client",u)}else console.log("Unknown message from webview",u)}}}function st(t){let e=t.getText();return e.trim()===""?"empty":Gt.test(e)?"valid":"invalid"}var Gt=/shinyApp\(/;var it="SUE_START_SIGNAL",at="SUE_END_SIGNAL";async function pt(t,e,{timeout_ms:o=1e3,verbose:n=!1}={}){let r=c=>{n&&console.log(`runRCommand: ${c}`)},s="",i=!1,a=[];return t.exitCode!==null?{status:"error",errorMsg:`Can't run R command as background R process has exited with code ${t.exitCode}.`}:new Promise(c=>{function p(u){let g=u.toString().split(`
`);r("~~~Output chunk~~~");for(let R of g){let h=R.includes(it),y=R.includes(at),G=R.length===0;if(h){i=!0;continue}if(y){clearTimeout(v),c({status:"success",values:a}),r("Output finished"),f();break}!i||G||(r(R),s+=R+`
`,a.push(R))}}function d(u){let _=u.toString();s+=`stderr: ${_}
`,r("stderr: "+_)}function l(){c({status:"error",errorMsg:s}),f()}t.stdout.on("data",p),t.stderr.on("data",d),t.on("close",l);let v=setTimeout(()=>{c({status:"error",errorMsg:`Timeout, no response from run command within ${o}ms: ${e}
 Logs:
 ${s}`}),f()},o);function f(){t.stdout.off("data",p),t.stderr.off("data",d),t.off("close",l)}ct(`print('${it}');${e};print('${at}')`,t)})}async function ut(){async function t(){return await V(["--silent","--slave","--no-save","--no-restore"],{timeout_ms:5e3})}let e=await t();return{...e,async runCmd(o,n){return e.getIsRunning()||(console.warn("Background R Process has crashed. Restarting..."),e.stop(),e=await t(),console.warn("Background R Process restarted")),pt(e.proc,o,n)}}}function ct(t,e){e.stdin.write(`${t}
`)}function lt(){let t="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<32;o++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}var q=class{constructor(e){this.context=e;this.RProcess=null;ut().then(o=>{this.RProcess=o})}static register(e){let o=new q(e);return x.window.registerCustomEditorProvider(q.viewType,o,{webviewOptions:{retainContextWhenHidden:!0}})}async resolveCustomTextEditor(e,o,n){if(st(e)==="invalid"){let p="The active file doesn't appear to be a Shiny app. Make sure that the script is either empty or has a valid shiny app in it.";throw x.window.showErrorMessage(p),o.dispose(),new Error(p)}if(o.webview.options={enableScripts:!0},o.webview.html=this.getHtmlForWebview(o.webview),!this.RProcess)throw new Error("Don't have an R Process to pass to editor backend!");let s=rt({RProcess:this.RProcess,document:e,sendMessage:p=>o.webview.postMessage(p)}),i=x.workspace.onDidChangeTextDocument(p=>{p.document.uri.toString()===e.uri.toString()&&s.onDocumentChanged()}),a=x.workspace.onDidSaveTextDocument(p=>{p.uri.toString()===e.uri.toString()&&s.onDocumentSaved()}),c=o.webview.onDidReceiveMessage(s.onDidReceiveMessage);o.onDidDispose(()=>{i.dispose(),a.dispose(),c.dispose()})}getHtmlForWebview(e){let o=e.asWebviewUri(x.Uri.joinPath(this.context.extensionUri,"media","build","extension-editor.js")),n=e.asWebviewUri(x.Uri.joinPath(this.context.extensionUri,"media","build","style.css")),r=lt(),s=e.cspSource;return`
			<!DOCTYPE html>
			<html lang="en">
			<head>
				<meta charset="UTF-8">
				<script>
				// This is needed for various older packages that require the global
				// object to be defined because it typically was with older bundlers like
				// webpack
				var global = window;
			  </script>
				<!--
				Use a content security policy to only allow loading images from https or from our extension directory,
				and only allow scripts that have a specific nonce.
				-->
				<meta 
          http-equiv="Content-Security-Policy" 
          content="default-src 'none'; frame-src http://localhost:*/ ${s} https:; img-src ${s} data:; style-src ${e.cspSource} 'unsafe-inline'; script-src 'nonce-${r}';">

				<meta name="viewport" content="width=device-width, initial-scale=1.0">

				
				<link href="${n}" rel="stylesheet" />
				
				<title>Shiny UI Editor</title>
			</head>
			<body style="padding-inline: 0;">
				<noscript>You need to enable JavaScript to run this app.</noscript>
				<div id="root" style="height: 100vh; display: relative"></div>
				<script type="module" nonce="${r}" src="${o}"></script>
			</body>
			</html>`}},F=q;F.viewType="shinyuieditor.appFile";function $t(t){t.subscriptions.push(F.register(t)),t.subscriptions.push(te.commands.registerCommand("shinyuieditor.startEditorOnActiveFile",pe),te.commands.registerCommand("shinyuieditor.launchEditor",se))}0&&(module.exports={activate});
